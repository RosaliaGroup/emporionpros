<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agent Dashboard ‚Äî Emporion Pros</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="ep-supabase.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#f3f4f6;min-height:100vh}
.dash{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
.sidebar{background:white;border-right:1px solid #e5e7eb;padding:20px 0;position:sticky;top:0;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
.sidebar-logo{padding:0 20px 20px;font-size:20px;font-weight:800;color:#1a56db;border-bottom:1px solid #e5e7eb;margin-bottom:12px}
.sidebar-logo span{color:#f97316}
.sidebar-user{padding:12px 20px;margin-bottom:12px}
.sidebar-user-name{font-weight:700;font-size:14px;color:#111}
.sidebar-user-role{font-size:12px;color:#6b7280;text-transform:capitalize}
.sidebar a{display:flex;align-items:center;gap:10px;padding:11px 20px;color:#374151;text-decoration:none;font-size:14px;font-weight:500;transition:.2s;border-left:3px solid transparent}
.sidebar a:hover{background:#f9fafb;color:#1a56db}
.sidebar a.active{background:#eff6ff;color:#1a56db;border-left-color:#1a56db;font-weight:600}
.sidebar-section{font-size:11px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px;padding:16px 20px 8px}
.main{padding:32px;overflow-y:auto}
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px}
.main-header h1{font-size:28px;font-weight:800;color:#111}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:white;padding:24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.stat-label{font-size:13px;color:#6b7280;margin-bottom:6px}
.stat-value{font-size:32px;font-weight:800;color:#1a56db}
.section{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:24px;overflow:hidden}
.section-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #e5e7eb}
.section-header h2{font-size:18px;font-weight:700}
.section-body{padding:24px}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 16px;background:#f9fafb;font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}
td{padding:14px 16px;border-bottom:1px solid #f3f4f6;font-size:14px}
tr:hover td{background:#f9fafb}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-new{background:#eff6ff;color:#1a56db}
.badge-contacted{background:#fef3c7;color:#92400e}
.badge-qualified{background:#d1fae5;color:#065f46}
.badge-pending{background:#fef3c7;color:#92400e}
.badge-confirmed{background:#d1fae5;color:#065f46}
.badge-active{background:#d1fae5;color:#065f46}
.badge-draft{background:#f3f4f6;color:#6b7280}
.badge-completed{background:#e0e7ff;color:#3730a3}
.badge-cancelled{background:#fee2e2;color:#991b1b}
.btn{padding:8px 16px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:.2s}
.btn-primary{background:#1a56db;color:white}.btn-primary:hover{background:#1e3a8a}
.btn-outline{background:white;color:#374151;border:1px solid #e5e7eb}.btn-outline:hover{border-color:#1a56db;color:#1a56db}
.btn-danger{background:#fee2e2;color:#dc2626}.btn-danger:hover{background:#fecaca}
.btn-sm{padding:5px 12px;font-size:12px}
.empty{text-align:center;padding:48px;color:#9ca3af}
.empty-icon{font-size:48px;margin-bottom:12px}
.tab-content{display:none}.tab-content.active{display:block}
.signout-btn{margin-top:auto;padding:12px 20px;color:#ef4444;font-size:14px;cursor:pointer;border:none;background:none;text-align:left;width:100%;font-family:inherit;font-weight:500;display:flex;align-items:center;gap:10px}
.signout-btn:hover{background:#fef2f2}
.loading{text-align:center;padding:40px;color:#6b7280}
@media(max-width:768px){.dash{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px}}
</style>
</head>
<body>
<div class="dash">
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">Emporion<span>Pros</span></div>
    <div class="sidebar-user">
      <div class="sidebar-user-name" id="user-name">Loading...</div>
      <div class="sidebar-user-role" id="user-role">‚Äî</div>
    </div>
    <a href="#overview" class="active" onclick="showTab('overview',this)">üìä Overview</a>
    <a href="#leads" onclick="showTab('leads',this)">üë• Leads</a>
    <a href="#listings" onclick="showTab('listings',this)">üè† Listings</a>
    <a href="#appointments" onclick="showTab('appointments',this)">üìÖ Appointments</a>
    <a href="#campaigns" onclick="showTab('campaigns',this)">üì£ Campaigns</a>
    <div class="sidebar-section">Tools</div>
    <a href="/list-property.html">‚ûï Add Listing</a>
    <a href="/vendors.html">üîß Vendors</a>
    <a href="/">üåê View Site</a>
    <a href="/fub-aria-dashboard.html">üîó FUB Integration</a>
    <a href="/fub-aria-dashboard.html">ü§ñ AI Calling (Aria)</a>
    <button class="signout-btn" onclick="EPAuth.signOut()">üö™ Sign Out</button>
  </nav>
  <div class="main">
    <div class="tab-content active" id="tab-overview">
      <div class="main-header"><h1>Welcome back, <span id="welcome-name">Agent</span>!</h1></div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Leads</div><div class="stat-value" id="stat-leads">0</div></div>
        <div class="stat-card"><div class="stat-label">Active Listings</div><div class="stat-value" id="stat-listings">0</div></div>
        <div class="stat-card"><div class="stat-label">Appointments</div><div class="stat-value" id="stat-appointments">0</div></div>
        <div class="stat-card"><div class="stat-label">Campaigns</div><div class="stat-value" id="stat-campaigns">0</div></div>
      </div>
      <div class="section"><div class="section-header"><h2>Recent Leads</h2><button class="btn btn-sm btn-primary" onclick="openUploadModal()" style="margin-left:auto">üì§ Upload Excel</button></div><div class="section-body" id="recent-leads"><div class="loading">Loading...</div></div></div>
      <div class="section"><div class="section-header"><h2>Upcoming Appointments</h2></div><div class="section-body" id="recent-appointments"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-leads">
      <div class="main-header"><h1>Leads</h1><button class="btn btn-primary" onclick="openUploadModal()">üì§ Upload Excel/CSV</button></div>
      <div class="section"><div class="section-body" id="all-leads"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-listings">
      <div class="main-header"><h1>My Listings</h1><a href="/list-property.html" class="btn btn-primary">‚ûï Add Listing</a></div>
      <div class="section"><div class="section-body" id="all-listings"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-appointments">
      <div class="main-header"><h1>Appointments</h1></div>
      <div class="section"><div class="section-body" id="all-appointments"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-campaigns">
      <div class="main-header"><h1>Campaigns</h1><button class="btn btn-primary" onclick="showCreateCampaign()">‚ûï New Campaign</button></div>
      <div class="section"><div class="section-body" id="all-campaigns"><div class="loading">Loading...</div></div></div>
    </div>
  </div>
</div>
<script>
function showTab(name, el) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  const tab = document.getElementById('tab-' + name);
  if (tab) tab.classList.add('active');
  if (el) el.classList.add('active');
  loadTabData(name);
}
function checkHash() {
  const hash = window.location.hash.replace('#', '');
  if (hash) { const link = document.querySelector(`.sidebar a[href="#${hash}"]`); if (link) showTab(hash, link); }
}
async function loadTabData(tab) {
  switch(tab) {
    case 'leads': await loadLeads(); break;
    case 'listings': await loadListings(); break;
    case 'appointments': await loadAppointments(); break;
    case 'campaigns': await loadCampaigns(); break;
  }
}
async function loadLeads() {
  const { data: leads } = await EPLeads.getLeads();
  const c = document.getElementById('all-leads');
  if (!leads || !leads.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üë•</div><p>No leads yet.</p></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Source</th><th>Status</th><th>Date</th></tr></thead>
    <tbody>${leads.map(l => `<tr><td><strong>${l.name||'‚Äî'}</strong></td><td>${l.email}</td><td>${l.phone||'‚Äî'}</td><td>${l.source||'‚Äî'}</td><td><span class="badge badge-${l.status}">${l.status}</span></td><td>${new Date(l.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
}
async function loadListings() {
  const { data: listings } = await EPListings.getMyListings();
  const c = document.getElementById('all-listings');
  if (!listings || !listings.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üè†</div><p>No listings yet.</p><a href="/list-property.html" class="btn btn-primary" style="margin-top:12px">Add Your First Listing</a></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Property</th><th>Price</th><th>Type</th><th>Status</th><th>Views</th><th>Date</th></tr></thead>
    <tbody>${listings.map(l => `<tr><td><strong>${l.title}</strong><br><span style="font-size:12px;color:#6b7280">${l.address||''} ${l.city||''}</span></td><td>$${Number(l.price).toLocaleString()}${l.type==='rent'?'/mo':''}</td><td>${l.type}</td><td><span class="badge badge-${l.status}">${l.status}</span></td><td>${l.views_count||0}</td><td>${new Date(l.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
}
async function loadAppointments() {
  const { data: appts } = await EPAppointments.getMyAppointments();
  const c = document.getElementById('all-appointments');
  if (!appts || !appts.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üìÖ</div><p>No appointments yet.</p></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Client</th><th>Property</th><th>Date</th><th>Time</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody>${appts.map(a => `<tr><td><strong>${a.client_name}</strong><br><span style="font-size:12px;color:#6b7280">${a.client_email}</span></td><td>${a.listings?a.listings.title:'‚Äî'}</td><td>${a.appointment_date}</td><td>${a.appointment_time}</td><td>${a.type}</td><td><span class="badge badge-${a.status}">${a.status}</span></td>
      <td>${a.status==='pending'?`<button class="btn btn-sm btn-primary" onclick="updateAppt(${a.id},'confirmed')">Confirm</button> <button class="btn btn-sm btn-danger" onclick="updateAppt(${a.id},'cancelled')">Cancel</button>`:'‚Äî'}</td></tr>`).join('')}</tbody></table>`;
}
async function updateAppt(id, status) { await EPAppointments.updateStatus(id, status); loadAppointments(); }
async function loadCampaigns() {
  const { data: campaigns } = await EPCampaigns.getMyCampaigns();
  const c = document.getElementById('all-campaigns');
  if (!campaigns || !campaigns.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üì£</div><p>No campaigns yet.</p><button class="btn btn-primary" onclick="showCreateCampaign()" style="margin-top:12px">Create Your First Campaign</button></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Campaign</th><th>Type</th><th>Property</th><th>Status</th><th>Date</th></tr></thead>
    <tbody>${campaigns.map(c => `<tr><td><strong>${c.name}</strong></td><td>${c.type}</td><td>${c.listings?c.listings.title:'‚Äî'}</td><td><span class="badge badge-${c.status}">${c.status}</span></td><td>${new Date(c.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
}
function showCreateCampaign() { alert('Campaign builder coming soon!'); }
async function loadOverview() {
  const { data: leads } = await EPLeads.getLeads();
  const { data: listings } = await EPListings.getMyListings();
  const { data: appts } = await EPAppointments.getMyAppointments();
  const { data: campaigns } = await EPCampaigns.getMyCampaigns();
  document.getElementById('stat-leads').textContent = leads?.length || 0;
  document.getElementById('stat-listings').textContent = listings?.length || 0;
  document.getElementById('stat-appointments').textContent = appts?.length || 0;
  document.getElementById('stat-campaigns').textContent = campaigns?.length || 0;
  const rl = document.getElementById('recent-leads');
  if (leads && leads.length) { rl.innerHTML = `<table><thead><tr><th>Name</th><th>Email</th><th>Source</th><th>Status</th></tr></thead><tbody>${leads.slice(0,5).map(l=>`<tr><td>${l.name||'‚Äî'}</td><td>${l.email}</td><td>${l.source||'‚Äî'}</td><td><span class="badge badge-${l.status}">${l.status}</span></td></tr>`).join('')}</tbody></table>`; }
  else { rl.innerHTML = '<div class="empty">No leads yet</div>'; }
  const ra = document.getElementById('recent-appointments');
  if (appts && appts.length) { ra.innerHTML = `<table><thead><tr><th>Client</th><th>Date</th><th>Time</th><th>Status</th></tr></thead><tbody>${appts.slice(0,5).map(a=>`<tr><td>${a.client_name}</td><td>${a.appointment_date}</td><td>${a.appointment_time}</td><td><span class="badge badge-${a.status}">${a.status}</span></td></tr>`).join('')}</tbody></table>`; }
  else { ra.innerHTML = '<div class="empty">No appointments yet</div>'; }
}
document.addEventListener('DOMContentLoaded', async () => {
  const user = await EPAuth.getUser();
  if (!user) { window.location.href = '/login.html'; return; }
  const profile = await EPAuth.getProfile();
  const name = profile?.full_name || user.email.split('@')[0];
  document.getElementById('user-name').textContent = name;
  document.getElementById('user-role').textContent = profile?.role || 'user';
  document.getElementById('welcome-name').textContent = name.split(' ')[0];
  await loadOverview();
  checkHash();
});
</script>
<!-- EXCEL UPLOAD MODAL -->
<div id="uploadModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px)">
  <div style="background:white;border-radius:12px;padding:28px;width:90%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="font-size:18px;font-weight:700">üì§ Upload Leads</h2>
      <button onclick="closeUploadModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280">‚úï</button>
    </div>
    <div id="uploadDropZone" style="border:2px dashed #d1d5db;border-radius:10px;padding:40px 20px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:16px"
      ondragover="event.preventDefault();this.style.borderColor='#1a56db';this.style.background='#eff6ff'"
      ondragleave="this.style.borderColor='#d1d5db';this.style.background='white'"
      ondrop="event.preventDefault();this.style.borderColor='#d1d5db';this.style.background='white';handleUploadFile(event.dataTransfer.files[0])"
      onclick="document.getElementById('uploadFileInput').click()">
      <div style="font-size:36px;margin-bottom:8px">üìÅ</div>
      <div style="font-size:14px;font-weight:600;color:#374151">Drag & drop Excel or CSV file here</div>
      <div style="font-size:12px;color:#9ca3af;margin-top:4px">or click to browse ‚Äî .xlsx, .xls, .csv</div>
    </div>
    <input type="file" id="uploadFileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleUploadFile(this.files[0])">
    <div id="uploadPreview" style="display:none;margin-bottom:16px">
      <div style="font-size:13px;font-weight:600;margin-bottom:8px" id="uploadFileName"></div>
      <div style="max-height:200px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px" id="uploadPreviewTable"></div>
      <div style="font-size:12px;color:#6b7280;margin-top:8px" id="uploadSummary"></div>
    </div>
    <div id="uploadProgress" style="display:none;margin-bottom:16px">
      <div style="height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden"><div id="uploadBar" style="height:100%;background:#1a56db;border-radius:3px;width:0%;transition:width .3s"></div></div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px" id="uploadStatus">Uploading...</div>
    </div>
    <div id="uploadResult" style="display:none;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px"></div>
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
      <a href="/.netlify/functions/fub-leads" target="_blank" style="font-size:12px;color:#1a56db;text-decoration:none">üì• Download template</a>
      <div style="display:flex;gap:8px">
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#374151"><input type="checkbox" id="uploadPushFUB" checked> Also push to FUB</label>
        <button class="btn btn-primary" id="uploadBtn" onclick="submitUpload()" disabled>Upload Leads</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let uploadedLeads = [];

function openUploadModal() {
  document.getElementById('uploadModal').style.display = 'flex';
  resetUploadModal();
}
function closeUploadModal() {
  document.getElementById('uploadModal').style.display = 'none';
}
function resetUploadModal() {
  uploadedLeads = [];
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('uploadResult').style.display = 'none';
  document.getElementById('uploadBtn').disabled = true;
  document.getElementById('uploadDropZone').style.display = 'block';
  document.getElementById('uploadFileInput').value = '';
}

function handleUploadFile(file) {
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx', 'xls', 'csv'].includes(ext)) {
    alert('Please upload an Excel (.xlsx/.xls) or CSV file');
    return;
  }
  document.getElementById('uploadFileName').textContent = 'üìÑ ' + file.name;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      let data;
      if (ext === 'csv') {
        const text = e.target.result;
        const rows = text.split('\n').map(r => r.split(',').map(c => c.trim().replace(/^"|"$/g, '')));
        const headers = rows[0];
        data = rows.slice(1).filter(r => r.some(c => c)).map(r => {
          const obj = {};
          headers.forEach((h, i) => { obj[h] = r[i] || ''; });
          return obj;
        });
      } else {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(ws);
      }
      uploadedLeads = data;
      showUploadPreview(data, file.name);
    } catch (err) {
      alert('Error reading file: ' + err.message);
    }
  };
  if (ext === 'csv') reader.readAsText(file);
  else reader.readAsBinaryString(file);
}

function showUploadPreview(data, fileName) {
  if (!data.length) { alert('No data found in file'); return; }
  const keys = Object.keys(data[0]);
  const preview = data.slice(0, 5);
  let html = '<table style="width:100%;font-size:12px;border-collapse:collapse"><thead><tr>';
  keys.forEach(k => { html += '<th style="padding:6px 8px;background:#f9fafb;text-align:left;font-size:11px;color:#6b7280">' + k + '</th>'; });
  html += '</tr></thead><tbody>';
  preview.forEach(row => {
    html += '<tr>';
    keys.forEach(k => { html += '<td style="padding:5px 8px;border-top:1px solid #f3f4f6;font-size:12px">' + (row[k] || '') + '</td>'; });
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('uploadPreviewTable').innerHTML = html;
  document.getElementById('uploadSummary').textContent = data.length + ' leads found' + (data.length > 5 ? ' (showing first 5)' : '');
  document.getElementById('uploadPreview').style.display = 'block';
  document.getElementById('uploadDropZone').style.display = 'none';
  document.getElementById('uploadBtn').disabled = false;
}

async function submitUpload() {
  if (!uploadedLeads.length) return;
  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.textContent = 'Uploading...';
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('uploadBar').style.width = '30%';
  document.getElementById('uploadStatus').textContent = 'Sending ' + uploadedLeads.length + ' leads...';

  const pushToFUB = document.getElementById('uploadPushFUB').checked;

  try {
    document.getElementById('uploadBar').style.width = '60%';
    const res = await fetch('/.netlify/functions/upload-leads', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ leads: uploadedLeads, pushToFUB })
    });
    const data = await res.json();
    document.getElementById('uploadBar').style.width = '100%';

    const resultEl = document.getElementById('uploadResult');
    if (data.success) {
      resultEl.style.background = '#d1fae5';
      resultEl.style.color = '#065f46';
      resultEl.innerHTML = '‚úÖ <strong>Upload complete!</strong><br>Created: ' + data.created + ' | Updated: ' + data.updated + ' | Skipped: ' + data.skipped + (data.fubPushed ? ' | Pushed to FUB: ' + data.fubPushed : '') + (data.errors ? ' | Errors: ' + data.errors : '');
    } else {
      resultEl.style.background = '#fee2e2';
      resultEl.style.color = '#991b1b';
      resultEl.innerHTML = '‚ùå Upload failed: ' + (data.error || 'Unknown error');
    }
    resultEl.style.display = 'block';
    document.getElementById('uploadStatus').textContent = 'Done!';

    // Refresh leads table
    if (typeof loadOverview === 'function') loadOverview();
    if (typeof loadLeads === 'function') loadLeads();
  } catch (err) {
    document.getElementById('uploadResult').style.display = 'block';
    document.getElementById('uploadResult').style.background = '#fee2e2';
    document.getElementById('uploadResult').style.color = '#991b1b';
    document.getElementById('uploadResult').innerHTML = '‚ùå Error: ' + err.message;
  }
  btn.textContent = 'Upload Leads';
  btn.disabled = false;
}
</script>
</body>
</html>
