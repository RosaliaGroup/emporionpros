<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agent Dashboard ‚Äî Emporion Pros</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="ep-supabase.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#f3f4f6;min-height:100vh}
.dash{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
.sidebar{background:white;border-right:1px solid #e5e7eb;padding:20px 0;position:sticky;top:0;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
.sidebar-logo{padding:0 20px 20px;font-size:20px;font-weight:800;color:#1a56db;border-bottom:1px solid #e5e7eb;margin-bottom:12px}
.sidebar-logo span{color:#f97316}
.sidebar-user{padding:12px 20px;margin-bottom:12px}
.sidebar-user-name{font-weight:700;font-size:14px;color:#111}
.sidebar-user-role{font-size:12px;color:#6b7280;text-transform:capitalize}
.sidebar a{display:flex;align-items:center;gap:10px;padding:11px 20px;color:#374151;text-decoration:none;font-size:14px;font-weight:500;transition:.2s;border-left:3px solid transparent}
.sidebar a:hover{background:#f9fafb;color:#1a56db}
.sidebar a.active{background:#eff6ff;color:#1a56db;border-left-color:#1a56db;font-weight:600}
.sidebar-section{font-size:11px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px;padding:16px 20px 8px}
.main{padding:32px;overflow-y:auto}
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px}
.main-header h1{font-size:28px;font-weight:800;color:#111}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:white;padding:24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.stat-label{font-size:13px;color:#6b7280;margin-bottom:6px}
.stat-value{font-size:32px;font-weight:800;color:#1a56db}
.section{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:24px;overflow:hidden}
.section-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #e5e7eb}
.section-header h2{font-size:18px;font-weight:700}
.section-body{padding:24px}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 16px;background:#f9fafb;font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}
td{padding:14px 16px;border-bottom:1px solid #f3f4f6;font-size:14px}
tr:hover td{background:#f9fafb}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-new{background:#eff6ff;color:#1a56db}
.badge-contacted{background:#fef3c7;color:#92400e}
.badge-qualified{background:#d1fae5;color:#065f46}
.badge-pending{background:#fef3c7;color:#92400e}
.badge-confirmed{background:#d1fae5;color:#065f46}
.badge-active{background:#d1fae5;color:#065f46}
.badge-draft{background:#f3f4f6;color:#6b7280}
.badge-completed{background:#e0e7ff;color:#3730a3}
.badge-cancelled{background:#fee2e2;color:#991b1b}
.btn{padding:8px 16px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:.2s}
.btn-primary{background:#1a56db;color:white}.btn-primary:hover{background:#1e3a8a}
.btn-outline{background:white;color:#374151;border:1px solid #e5e7eb}.btn-outline:hover{border-color:#1a56db;color:#1a56db}
.btn-danger{background:#fee2e2;color:#dc2626}.btn-danger:hover{background:#fecaca}
.btn-sm{padding:5px 12px;font-size:12px}
.empty{text-align:center;padding:48px;color:#9ca3af}
.empty-icon{font-size:48px;margin-bottom:12px}
.tab-content{display:none}.tab-content.active{display:block}
.signout-btn{margin-top:auto;padding:12px 20px;color:#ef4444;font-size:14px;cursor:pointer;border:none;background:none;text-align:left;width:100%;font-family:inherit;font-weight:500;display:flex;align-items:center;gap:10px}
.signout-btn:hover{background:#fef2f2}
.loading{text-align:center;padding:40px;color:#6b7280}
@media(max-width:768px){.dash{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px}}
</style>
</head>
<body>
<div class="dash">
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">Emporion<span>Pros</span></div>
    <div class="sidebar-user">
      <div class="sidebar-user-name" id="user-name">Loading...</div>
      <div class="sidebar-user-role" id="user-role">‚Äî</div>
    </div>
    <a href="#overview" class="active" onclick="showTab('overview',this)">üìä Overview</a>
    <a href="#leads" onclick="showTab('leads',this)">üë• Leads</a>
    <a href="#listings" onclick="showTab('listings',this)">üè† Listings</a>
    <a href="#appointments" onclick="showTab('appointments',this)">üìÖ Appointments</a>
    <a href="#campaigns" onclick="showTab('campaigns',this)">üì£ Campaigns</a>
    <div class="sidebar-section">Tools</div>
    <a href="/list-property.html">‚ûï Add Listing</a>
    <a href="/vendors.html">üîß Vendors</a>
    <a href="/">üåê View Site</a>
    <button class="signout-btn" onclick="EPAuth.signOut()">üö™ Sign Out</button>
  </nav>
  <div class="main">
    <div class="tab-content active" id="tab-overview">
      <div class="main-header"><h1>Welcome back, <span id="welcome-name">Agent</span>!</h1></div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Leads</div><div class="stat-value" id="stat-leads">0</div></div>
        <div class="stat-card"><div class="stat-label">Active Listings</div><div class="stat-value" id="stat-listings">0</div></div>
        <div class="stat-card"><div class="stat-label">Appointments</div><div class="stat-value" id="stat-appointments">0</div></div>
        <div class="stat-card"><div class="stat-label">Campaigns</div><div class="stat-value" id="stat-campaigns">0</div></div>
      </div>
      <div class="section"><div class="section-header"><h2>Recent Leads</h2></div><div class="section-body" id="recent-leads"><div class="loading">Loading...</div></div></div>
      <div class="section"><div class="section-header"><h2>Upcoming Appointments</h2></div><div class="section-body" id="recent-appointments"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-leads">
      <div class="main-header"><h1>Leads</h1></div>
      <div class="section"><div class="section-body" id="all-leads"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-listings">
      <div class="main-header"><h1>My Listings</h1><a href="/list-property.html" class="btn btn-primary">‚ûï Add Listing</a></div>
      <div class="section"><div class="section-body" id="all-listings"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-appointments">
      <div class="main-header"><h1>Appointments</h1></div>
      <div class="section"><div class="section-body" id="all-appointments"><div class="loading">Loading...</div></div></div>
    </div>
    <div class="tab-content" id="tab-campaigns">
      <div class="main-header"><h1>Campaigns</h1><button class="btn btn-primary" onclick="showCreateCampaign()">‚ûï New Campaign</button></div>
      <div class="section"><div class="section-body" id="all-campaigns"><div class="loading">Loading...</div></div></div>
    </div>
  </div>
</div>
<script>
function showTab(name, el) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  const tab = document.getElementById('tab-' + name);
  if (tab) tab.classList.add('active');
  if (el) el.classList.add('active');
  loadTabData(name);
}
function checkHash() {
  const hash = window.location.hash.replace('#', '');
  if (hash) { const link = document.querySelector(`.sidebar a[href="#${hash}"]`); if (link) showTab(hash, link); }
}
async function loadTabData(tab) {
  switch(tab) {
    case 'leads': await loadLeads(); break;
    case 'listings': await loadListings(); break;
    case 'appointments': await loadAppointments(); break;
    case 'campaigns': await loadCampaigns(); break;
  }
}
async function loadLeads() {
  const { data: leads } = await EPLeads.getLeads();
  const c = document.getElementById('all-leads');
  if (!leads || !leads.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üë•</div><p>No leads yet.</p></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Source</th><th>Status</th><th>Date</th></tr></thead>
    <tbody>${leads.map(l => `<tr><td><strong>${l.name||'‚Äî'}</strong></td><td>${l.email}</td><td>${l.phone||'‚Äî'}</td><td>${l.source||'‚Äî'}</td><td><span class="badge badge-${l.status}">${l.status}</span></td><td>${new Date(l.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
}
async function loadListings() {
  const { data: listings } = await EPListings.getMyListings();
  const c = document.getElementById('all-listings');
  if (!listings || !listings.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üè†</div><p>No listings yet.</p><a href="/list-property.html" class="btn btn-primary" style="margin-top:12px">Add Your First Listing</a></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Property</th><th>Price</th><th>Type</th><th>Status</th><th>Views</th><th>Date</th></tr></thead>
    <tbody>${listings.map(l => `<tr><td><strong>${l.title}</strong><br><span style="font-size:12px;color:#6b7280">${l.address||''} ${l.city||''}</span></td><td>$${Number(l.price).toLocaleString()}${l.type==='rent'?'/mo':''}</td><td>${l.type}</td><td><span class="badge badge-${l.status}">${l.status}</span></td><td>${l.views_count||0}</td><td>${new Date(l.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
}
async function loadAppointments() {
  const { data: appts } = await EPAppointments.getMyAppointments();
  const c = document.getElementById('all-appointments');
  if (!appts || !appts.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üìÖ</div><p>No appointments yet.</p></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Client</th><th>Property</th><th>Date</th><th>Time</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody>${appts.map(a => `<tr><td><strong>${a.client_name}</strong><br><span style="font-size:12px;color:#6b7280">${a.client_email}</span></td><td>${a.listings?a.listings.title:'‚Äî'}</td><td>${a.appointment_date}</td><td>${a.appointment_time}</td><td>${a.type}</td><td><span class="badge badge-${a.status}">${a.status}</span></td>
      <td>${a.status==='pending'?`<button class="btn btn-sm btn-primary" onclick="updateAppt(${a.id},'confirmed')">Confirm</button> <button class="btn btn-sm btn-danger" onclick="updateAppt(${a.id},'cancelled')">Cancel</button>`:'‚Äî'}</td></tr>`).join('')}</tbody></table>`;
}
async function updateAppt(id, status) { await EPAppointments.updateStatus(id, status); loadAppointments(); }
async function loadCampaigns() {
  const { data: campaigns } = await EPCampaigns.getMyCampaigns();
  const c = document.getElementById('all-campaigns');
  if (!campaigns || !campaigns.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üì£</div><p>No campaigns yet.</p><button class="btn btn-primary" onclick="showCreateCampaign()" style="margin-top:12px">Create Your First Campaign</button></div>'; return; }
  c.innerHTML = `<table><thead><tr><th>Campaign</th><th>Type</th><th>Property</th><th>Status</th><th>Date</th></tr></thead>
    <tbody>${campaigns.map(c => `<tr><td><strong>${c.name}</strong></td><td>${c.type}</td><td>${c.listings?c.listings.title:'‚Äî'}</td><td><span class="badge badge-${c.status}">${c.status}</span></td><td>${new Date(c.created_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
}
function showCreateCampaign() { alert('Campaign builder coming soon!'); }
async function loadOverview() {
  const { data: leads } = await EPLeads.getLeads();
  const { data: listings } = await EPListings.getMyListings();
  const { data: appts } = await EPAppointments.getMyAppointments();
  const { data: campaigns } = await EPCampaigns.getMyCampaigns();
  document.getElementById('stat-leads').textContent = leads?.length || 0;
  document.getElementById('stat-listings').textContent = listings?.length || 0;
  document.getElementById('stat-appointments').textContent = appts?.length || 0;
  document.getElementById('stat-campaigns').textContent = campaigns?.length || 0;
  const rl = document.getElementById('recent-leads');
  if (leads && leads.length) { rl.innerHTML = `<table><thead><tr><th>Name</th><th>Email</th><th>Source</th><th>Status</th></tr></thead><tbody>${leads.slice(0,5).map(l=>`<tr><td>${l.name||'‚Äî'}</td><td>${l.email}</td><td>${l.source||'‚Äî'}</td><td><span class="badge badge-${l.status}">${l.status}</span></td></tr>`).join('')}</tbody></table>`; }
  else { rl.innerHTML = '<div class="empty">No leads yet</div>'; }
  const ra = document.getElementById('recent-appointments');
  if (appts && appts.length) { ra.innerHTML = `<table><thead><tr><th>Client</th><th>Date</th><th>Time</th><th>Status</th></tr></thead><tbody>${appts.slice(0,5).map(a=>`<tr><td>${a.client_name}</td><td>${a.appointment_date}</td><td>${a.appointment_time}</td><td><span class="badge badge-${a.status}">${a.status}</span></td></tr>`).join('')}</tbody></table>`; }
  else { ra.innerHTML = '<div class="empty">No appointments yet</div>'; }
}
document.addEventListener('DOMContentLoaded', async () => {
  const user = await EPAuth.getUser();
  if (!user) { window.location.href = '/login.html'; return; }
  const profile = await EPAuth.getProfile();
  const name = profile?.full_name || user.email.split('@')[0];
  document.getElementById('user-name').textContent = name;
  document.getElementById('user-role').textContent = profile?.role || 'user';
  document.getElementById('welcome-name').textContent = name.split(' ')[0];
  await loadOverview();
  checkHash();
});
</script>
</body>
</html>
