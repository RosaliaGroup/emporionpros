<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>FUB + Aria Integration — Emporion Pros</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#f3f4f6;min-height:100vh}
.dash{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
.sidebar{background:white;border-right:1px solid #e5e7eb;padding:20px 0;position:sticky;top:0;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
.sidebar-logo{padding:0 20px 20px;font-size:20px;font-weight:800;color:#1a56db;border-bottom:1px solid #e5e7eb;margin-bottom:12px;cursor:pointer;text-decoration:none;display:block}
.sidebar-logo span{color:#f97316}
.sidebar-user{padding:12px 20px;margin-bottom:12px}
.sidebar-user-name{font-weight:700;font-size:14px;color:#111}
.sidebar-user-role{font-size:12px;color:#6b7280;text-transform:capitalize}
.sidebar-section{font-size:11px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px;padding:16px 20px 8px}
.sidebar a{display:flex;align-items:center;gap:10px;padding:11px 20px;color:#374151;text-decoration:none;font-size:14px;font-weight:500;transition:.2s;border-left:3px solid transparent}
.sidebar a:hover{background:#f9fafb;color:#1a56db}
.sidebar a.active{background:#eff6ff;color:#1a56db;border-left-color:#1a56db;font-weight:600}
.sidebar-property{margin:12px 16px;padding:14px;background:linear-gradient(135deg,#1a56db,#1e40af);border-radius:10px;color:white}
.sidebar-property-name{font-weight:700;font-size:14px}.sidebar-property-addr{font-size:11px;opacity:.8;margin-top:2px}
.sidebar-property-tag{display:inline-block;margin-top:8px;padding:3px 8px;background:rgba(255,255,255,.2);border-radius:4px;font-size:10px;font-weight:600;letter-spacing:.5px}
.main{padding:28px;overflow-y:auto}
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.main-header h1{font-size:26px;font-weight:800;color:#111}
.status-badge{display:flex;align-items:center;gap:6px;font-size:13px;color:#10b981;background:#d1fae5;padding:6px 14px;border-radius:20px;font-weight:600}
.status-dot{width:7px;height:7px;background:#10b981;border-radius:50%;display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.tabs{display:flex;gap:4px;background:white;padding:4px;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:20px;width:fit-content;flex-wrap:wrap}
.tab{padding:9px 18px;font-size:13px;font-weight:600;color:#6b7280;border:none;background:none;border-radius:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:6px;white-space:nowrap;font-family:inherit}
.tab:hover{color:#374151;background:#f9fafb}.tab.active{background:#1a56db;color:white;box-shadow:0 2px 8px rgba(26,86,219,.3)}
.tab-panel{display:none}.tab-panel.active{display:block}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin-bottom:20px}
.stat-card{background:white;padding:18px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);transition:.2s;cursor:pointer;border:2px solid transparent}
.stat-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);transform:translateY(-1px);border-color:#1a56db}
.stat-card.selected{border-color:#1a56db;background:#eff6ff}
.stat-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;font-size:18px}
.stat-icon.blue{background:#dbeafe}.stat-icon.green{background:#d1fae5}.stat-icon.yellow{background:#fef3c7}.stat-icon.red{background:#fee2e2}.stat-icon.purple{background:#ede9fe}
.stat-value{font-size:26px;font-weight:800;color:#1a56db;line-height:1}
.stat-label{font-size:12px;color:#6b7280;margin-top:3px;font-weight:500}
.stat-change{font-size:11px;font-weight:600;margin-top:5px;color:#10b981}
.card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:16px;overflow:hidden}
.card-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb}
.card-header h2{font-size:15px;font-weight:700}
.card-body{padding:20px}
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-input{flex:1;padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit}
.search-input:focus{outline:none;border-color:#1a56db;box-shadow:0 0 0 3px rgba(26,86,219,.1)}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 12px;background:#f9fafb;font-size:11px;font-weight:600;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px}
td{padding:11px 12px;border-bottom:1px solid #f3f4f6;font-size:13px}
tr{cursor:pointer;transition:.15s}tr:hover td{background:#eff6ff}
tr.selected td{background:#dbeafe}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-new{background:#dbeafe;color:#1a56db}.badge-hot{background:#fee2e2;color:#ef4444}
.badge-contacted{background:#fef3c7;color:#b45309}.badge-touring{background:#ede9fe;color:#8b5cf6}
.badge-closed{background:#d1fae5;color:#047857}.badge-cold{background:#f3f4f6;color:#6b7280}
.badge-warm{background:#fef3c7;color:#b45309}
.btn{padding:8px 16px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#1a56db;color:white}.btn-primary:hover{background:#1e3a8a}
.btn-outline{background:white;color:#374151;border:1px solid #e5e7eb}.btn-outline:hover{border-color:#1a56db;color:#1a56db}
.btn-success{background:#10b981;color:white}.btn-success:hover{background:#059669}
.btn-danger{background:#ef4444;color:white}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-icon{width:30px;height:30px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:6px;border:1px solid #e5e7eb;background:white;color:#6b7280;cursor:pointer;transition:.2s;font-size:14px}
.btn-icon:hover{background:#eff6ff;color:#1a56db;border-color:#1a56db}
.form-group{margin-bottom:12px}.form-label{display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px}
.form-input{width:100%;padding:9px 12px;border:1px solid #e5e7eb;border-radius:7px;font-size:13px;font-family:inherit}
.form-input:focus{outline:none;border-color:#1a56db;box-shadow:0 0 0 3px rgba(26,86,219,.1)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.call-dialer{background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:12px;padding:24px;color:white;text-align:center}
.call-dialer-title{font-size:11px;font-weight:600;opacity:.5;text-transform:uppercase;letter-spacing:1px;margin-bottom:14px}
.call-dialer-number{font-family:monospace;font-size:24px;font-weight:500;margin-bottom:4px;letter-spacing:2px}
.call-dialer-name{font-size:13px;opacity:.5;margin-bottom:18px}
.call-dialer-actions{display:flex;gap:12px;justify-content:center}
.call-btn{width:50px;height:50px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;font-size:20px}
.call-btn-green{background:#10b981;color:white}.call-btn-green:hover{background:#059669;transform:scale(1.08)}
.call-btn-red{background:#ef4444;color:white}.call-btn-red:hover{background:#dc2626;transform:scale(1.08)}
.call-btn-mute{background:rgba(255,255,255,.1);color:white}.call-btn-mute:hover{background:rgba(255,255,255,.2)}
.call-status{margin-top:14px;font-size:13px;opacity:.5}.call-status.active{color:#10b981;opacity:1}
.call-timer{font-family:monospace;font-size:18px;margin-top:6px}
.sms-layout{display:grid;grid-template-columns:240px 1fr;height:460px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:white}
.sms-contacts{border-right:1px solid #e5e7eb;overflow-y:auto}
.sms-contacts-header{padding:10px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;background:white;z-index:2}
.sms-contacts-header input{width:100%;padding:7px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;background:#f9fafb;font-family:inherit}
.sms-contact{display:flex;align-items:center;gap:8px;padding:10px;cursor:pointer;transition:.15s;border-bottom:1px solid #f3f4f6}
.sms-contact:hover{background:#f9fafb}.sms-contact.active{background:#eff6ff;border-left:3px solid #1a56db}
.sms-contact-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:white;flex-shrink:0}
.sms-contact-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sms-contact-preview{font-size:11px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sms-chat{display:flex;flex-direction:column}
.sms-chat-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
.sms-chat-name{font-weight:700;font-size:14px}.sms-chat-phone{font-size:12px;color:#6b7280}
.sms-messages{flex:1;padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;background:#f9fafb}
.sms-msg{max-width:75%;padding:9px 13px;border-radius:14px;font-size:13px;line-height:1.5}
.sms-msg.sent{align-self:flex-end;background:#1a56db;color:white;border-bottom-right-radius:4px}
.sms-msg.received{align-self:flex-start;background:white;border:1px solid #e5e7eb;border-bottom-left-radius:4px}
.sms-msg-time{font-size:10px;opacity:.5;margin-top:2px}
.sms-input-area{padding:10px 14px;border-top:1px solid #e5e7eb;display:flex;gap:8px;align-items:flex-end}
.sms-input-area textarea{flex:1;padding:9px 12px;border:1px solid #e5e7eb;border-radius:16px;font-size:13px;resize:none;height:38px;font-family:inherit;background:#f9fafb}
.sms-input-area textarea:focus{outline:none;border-color:#1a56db}
.sms-send-btn{width:36px;height:36px;border-radius:50%;background:#1a56db;color:white;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;font-size:15px}
.call-log-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f3f4f6}
.call-log-item:last-child{border:none}
.call-log-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.call-log-icon.outgoing{background:#d1fae5;color:#059669}.call-log-icon.incoming{background:#dbeafe;color:#1a56db}.call-log-icon.missed{background:#fee2e2;color:#ef4444}
.call-log-name{font-size:13px;font-weight:600}.call-log-detail{font-size:11px;color:#6b7280}
.call-log-time{font-size:11px;color:#9ca3af;text-align:right}.call-log-duration{font-size:11px;color:#6b7280}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.quick-action{display:flex;align-items:center;gap:8px;padding:12px;background:#f9fafb;border-radius:8px;border:1px solid transparent;cursor:pointer;transition:.2s}
.quick-action:hover{border-color:#1a56db;background:#eff6ff}
.quick-action-text{font-size:12px;font-weight:600}.quick-action-sub{font-size:10px;color:#6b7280}
.template-card{padding:10px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:.2s;margin-bottom:6px}
.template-card:hover{border-color:#1a56db;background:#eff6ff}
.template-name{font-size:12px;font-weight:600;margin-bottom:2px}.template-preview{font-size:11px;color:#6b7280;line-height:1.3}
.chart-bar{display:flex;align-items:flex-end;gap:6px;height:130px;padding-top:12px}
.chart-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.chart-bar-fill{width:100%;border-radius:3px 3px 0 0;min-height:3px}
.chart-bar-label{font-size:9px;color:#9ca3af;font-weight:600}.chart-bar-value{font-size:10px;font-weight:700;color:#374151}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3-1{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.mb-16{margin-bottom:16px}
.twilio-banner{background:linear-gradient(90deg,#fef3c7,#fff7ed);border:1px solid #fbbf24;border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:13px}
.twilio-banner strong{color:#92400e}.twilio-banner p{color:#78350f;margin:0}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal-overlay.show{display:flex}
.modal{background:white;border-radius:12px;padding:24px;width:90%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto}
.modal-title{font-size:18px;font-weight:700;margin-bottom:16px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.toast-container{position:fixed;top:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px}
.toast{padding:10px 16px;background:white;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.12);border-left:4px solid #10b981;font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;min-width:260px}
.toast.error{border-left-color:#ef4444}.toast.warning{border-left-color:#f59e0b}
.lead-detail{background:white;border-radius:12px;border:1px solid #e5e7eb;padding:20px;margin-top:16px}
.lead-detail h3{font-size:16px;font-weight:700;margin-bottom:12px}
.lead-detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f3f4f6;font-size:13px}
.lead-detail-label{color:#6b7280;font-weight:500}.lead-detail-value{font-weight:600}
.lead-detail-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
.schedule-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px}
.schedule-time{font-size:12px;font-weight:700;color:#1a56db;min-width:60px}.schedule-name{font-size:13px;font-weight:600}.schedule-status{font-size:11px;color:#6b7280}
@media(max-width:1024px){.dash{grid-template-columns:1fr}.sidebar{display:none}.sms-layout{grid-template-columns:1fr}.sms-contacts{display:none}.grid-2,.grid-3-1{grid-template-columns:1fr}}
@media(max-width:640px){.stats-grid{grid-template-columns:1fr}.tabs{overflow-x:auto;width:100%}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="dash">
  <nav class="sidebar">
    <a href="index.html" class="sidebar-logo">Emporion<span>Pros</span></a>
    <div class="sidebar-user"><div class="sidebar-user-name" id="user-name">Ana</div><div class="sidebar-user-role" id="user-role">Admin</div></div>
    <div class="sidebar-property"><div class="sidebar-property-name">Iron 65</div><div class="sidebar-property-addr">65 McWhorter St, Newark NJ</div><div class="sidebar-property-tag">LUXURY APARTMENTS</div></div>
    <div class="sidebar-section">Navigation</div>
    <a href="agent-dashboard.html">&#x1F4CA; Overview</a>
    <a href="fub-aria-dashboard.html" class="active">&#x1F4DE; FUB + Aria</a>
    <a href="agent-dashboard.html#leads">&#x1F465; All Leads</a>
    <a href="agent-dashboard.html#listings">&#x1F3E0; Listings</a>
    <a href="agent-dashboard.html#appointments">&#x1F4C5; Appointments</a>
    <a href="agent-dashboard.html#campaigns">&#x1F4E3; Campaigns</a>
    <div class="sidebar-section">Tools</div>
    <a href="listings.html">&#x1F50D; Browse Properties</a>
    <a href="list-property.html">&#x2795; Add Listing</a>
    <a href="vendors.html">&#x1F527; Vendors</a>
    <div class="sidebar-section">Account</div>
    <a href="index.html">&#x1F3E1; Home</a>
    <a href="#" onclick="if(window.EPAuth)EPAuth.signOut();else window.location='/'">&#x1F6AA; Sign Out</a>
  </nav>
  <main class="main">
    <div class="main-header"><h1>FUB + Aria Integration</h1><div class="status-badge"><span class="status-dot"></span> Aria Online</div></div>
    <div class="twilio-banner" id="twilioBanner"><span>&#9203;</span><div><strong>Twilio Verification Pending</strong><p>Calls/SMS activate once verified.</p></div><button class="btn btn-outline btn-sm" onclick="checkTwilioStatus()" style="margin-left:auto">Check</button></div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('leads')" id="tab-leads">&#x1F465; FUB Leads</button>
      <button class="tab" onclick="switchTab('calls')" id="tab-calls">&#x1F4DE; Aria Calls</button>
      <button class="tab" onclick="switchTab('sms')" id="tab-sms">&#x1F4AC; SMS</button>
      <button class="tab" onclick="switchTab('analytics')" id="tab-analytics">&#x1F4CA; Analytics</button>
      <button class="tab" onclick="switchTab('settings')" id="tab-settings">&#x2699; Settings</button>
    </div>

    <!-- ═══ TAB 1: FUB LEADS ═══ -->
    <div class="tab-panel active" id="panel-leads">
      <div class="stats-grid">
        <div class="stat-card" onclick="filterLeads('all')"><div class="stat-icon blue">&#x1F465;</div><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total Leads</div></div>
        <div class="stat-card" onclick="filterLeads('hot')"><div class="stat-icon red">&#x26A1;</div><div class="stat-value" id="stat-hot">0</div><div class="stat-label">Hot Leads</div></div>
        <div class="stat-card" onclick="filterLeads('touring')"><div class="stat-icon purple">&#x1F4C5;</div><div class="stat-value" id="stat-tours">0</div><div class="stat-label">Tours Booked</div></div>
        <div class="stat-card" onclick="filterLeads('closed')"><div class="stat-icon green">&#x2705;</div><div class="stat-value" id="stat-leases">0</div><div class="stat-label">Leases Signed</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>Lead Pipeline</h2>
          <div style="display:flex;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="syncFUBLeads()">&#x1F504; Sync FUB</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('addLeadModal')">+ Add Lead</button>
          </div>
        </div>
        <div class="card-body" style="padding:0 0 12px 0">
          <div style="padding:12px 20px 0"><div class="search-bar"><input type="text" class="search-input" id="leadSearch" placeholder="Search leads by name, phone, email, source..." oninput="searchLeads(this.value)"><select class="form-input" style="width:auto;min-width:120px" id="leadFilter" onchange="applyFilter()"><option value="all">All Leads</option><option value="hot">Hot</option><option value="warm">Warm</option><option value="new">New</option><option value="contacted">Contacted</option><option value="touring">Touring</option><option value="closed">Closed</option><option value="cold">Cold</option></select></div></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Lead</th><th>Phone</th><th>Source</th><th>Status</th><th>Budget</th><th>Move Date</th><th>Last Activity</th><th>Actions</th></tr></thead><tbody id="leadsTable"></tbody></table></div>
        </div>
      </div>
      <div id="leadDetailPanel"></div>
    </div>

    <!-- ═══ TAB 2: ARIA CALLS ═══ -->
    <div class="tab-panel" id="panel-calls">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon green">&#x1F4DE;</div><div class="stat-value" id="stat-calls">0</div><div class="stat-label">Total Calls</div></div>
        <div class="stat-card"><div class="stat-icon blue">&#x23F1;</div><div class="stat-value" id="stat-avgdur">0:00</div><div class="stat-label">Avg Duration</div></div>
        <div class="stat-card"><div class="stat-icon purple">&#x2705;</div><div class="stat-value" id="stat-answer">0%</div><div class="stat-label">Answer Rate</div></div>
        <div class="stat-card"><div class="stat-icon yellow">&#x1F4C5;</div><div class="stat-value" id="stat-booking">0%</div><div class="stat-label">Tour Booking Rate</div></div>
      </div>
      <div class="grid-3-1">
        <div>
          <div class="call-dialer">
            <div class="call-dialer-title">Aria AI Dialer</div>
            <div style="margin-bottom:14px"><select class="form-input" id="dialerLeadSelect" onchange="selectDialerLead()" style="background:rgba(255,255,255,.1);color:white;border-color:rgba(255,255,255,.2);text-align:center"><option value="">-- Select a lead to call --</option></select></div>
            <div class="call-dialer-number" id="dialerNumber">+1 (___) ___-____</div>
            <div class="call-dialer-name" id="dialerName">Select a lead above</div>
            <div class="call-dialer-actions">
              <button class="call-btn call-btn-mute" title="Mute">&#x1F507;</button>
              <button class="call-btn call-btn-green" id="callBtn" onclick="initiateAICall()">&#x1F4DE;</button>
              <button class="call-btn call-btn-red" id="hangupBtn" onclick="hangupCall()" style="display:none">&#x1F4F5;</button>
            </div>
            <div class="call-status" id="callStatus">Ready</div>
            <div class="call-timer" id="callTimer" style="display:none">00:00</div>
          </div>
          <!-- Auto-Call Schedule -->
          <div class="card" style="margin-top:16px">
            <div class="card-header"><h2>&#x1F4C5; Auto-Call Schedule</h2><button class="btn btn-primary btn-sm" onclick="openModal('scheduleModal')">+ Schedule</button></div>
            <div class="card-body" id="callSchedule"><div style="color:#9ca3af;font-size:13px;text-align:center;padding:12px">No scheduled calls. Click + Schedule to auto-dial leads.</div></div>
          </div>
          <div class="card" style="margin-top:16px"><div class="card-header"><h2>Recent Calls</h2></div><div class="card-body" id="callLog"></div></div>
        </div>
        <div>
          <div class="card mb-16"><div class="card-body">
            <div style="font-weight:700;margin-bottom:10px">Call Mode</div>
            <div class="form-group"><select class="form-input" id="callMode" onchange="updateCallMode()"><option value="vapi">VAPI + Claude (Recommended)</option><option value="twilio">Twilio TwiML</option><option value="manual">Manual</option></select></div>
            <div style="font-size:12px;color:#6b7280;line-height:1.5" id="callModeDesc">VAPI with Claude AI + Deepgram Luna voice.</div>
          </div></div>
          <div class="card mb-16"><div class="card-body">
            <div style="font-weight:700;margin-bottom:10px">Script Flow</div>
            <div style="font-size:12px;line-height:1.8;color:#374151">
              <div style="margin-bottom:6px"><strong style="color:#1a56db">1.</strong> Greeting → qualify interest</div>
              <div style="margin-bottom:6px"><strong style="color:#1a56db">2.</strong> Move date → Budget → Bedrooms</div>
              <div style="margin-bottom:6px"><strong style="color:#1a56db">3.</strong> Income/Credit check</div>
              <div style="margin-bottom:6px"><strong style="color:#1a56db">4.</strong> Match unit + present specials</div>
              <div style="margin-bottom:6px"><strong style="color:#1a56db">5.</strong> Book tour → collect email</div>
              <div><strong style="color:#10b981">6.</strong> Auto-SMS confirmation + cosigner</div>
            </div>
          </div></div>
          <div class="card"><div class="card-body">
            <div style="font-weight:700;margin-bottom:10px">Quick Actions</div>
            <div class="quick-actions">
              <div class="quick-action" onclick="bulkAction('hot')"><div>&#x26A1;</div><div><div class="quick-action-text">Call Hot Leads</div><div class="quick-action-sub" id="qa-hot">0 leads</div></div></div>
              <div class="quick-action" onclick="bulkAction('new')"><div>&#x1F465;</div><div><div class="quick-action-text">New Lead Blitz</div><div class="quick-action-sub" id="qa-new">0 leads</div></div></div>
              <div class="quick-action" onclick="bulkAction('follow')"><div>&#x1F504;</div><div><div class="quick-action-text">Follow-ups</div><div class="quick-action-sub">Re-engage cold</div></div></div>
              <div class="quick-action" onclick="bulkAction('rec')"><div>&#x25B6;</div><div><div class="quick-action-text">Recordings</div><div class="quick-action-sub">Call playback</div></div></div>
            </div>
          </div></div>
        </div>
      </div>
    </div>

    <!-- ═══ TAB 3: SMS ═══ -->
    <div class="tab-panel" id="panel-sms">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon blue">&#x1F4AC;</div><div class="stat-value" id="stat-smssent">0</div><div class="stat-label">SMS Sent</div></div>
        <div class="stat-card"><div class="stat-icon green">&#x2705;</div><div class="stat-value" id="stat-delivery">0%</div><div class="stat-label">Delivery Rate</div></div>
        <div class="stat-card"><div class="stat-icon purple">&#x1F4E9;</div><div class="stat-value" id="stat-response">0%</div><div class="stat-label">Response Rate</div></div>
        <div class="stat-card" onclick="filterLeads('touring');switchTab('leads')"><div class="stat-icon yellow">&#x1F4C5;</div><div class="stat-value" id="stat-smstours">0</div><div class="stat-label">Tours via SMS</div></div>
      </div>
      <div class="grid-3-1">
        <div>
          <div class="sms-layout">
            <div class="sms-contacts"><div class="sms-contacts-header"><input type="text" placeholder="Search..." oninput="filterConvos(this.value)"></div><div id="smsContactList"></div></div>
            <div class="sms-chat">
              <div class="sms-chat-header"><div><div class="sms-chat-name" id="chatName">Select a conversation</div><div class="sms-chat-phone" id="chatPhone"></div></div>
                <div style="display:flex;gap:4px"><button class="btn-icon" title="Call" onclick="callFromChat()">&#x1F4DE;</button><button class="btn-icon" title="Email" onclick="emailFromChat()">&#x1F4E7;</button></div>
              </div>
              <div class="sms-messages" id="chatMessages"><div style="text-align:center;color:#9ca3af;font-size:13px;margin:auto">Select a conversation</div></div>
              <div class="sms-input-area"><textarea id="smsInput" placeholder="Type a message..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendSMS()}"></textarea><button class="sms-send-btn" onclick="sendSMS()">&#x27A4;</button></div>
            </div>
          </div>
        </div>
        <div>
          <div class="card mb-16"><div class="card-body">
            <div style="font-weight:700;margin-bottom:10px">Templates</div>
            <div class="template-card" onclick="useTemplate('tour')"><div class="template-name">&#x1F4C5; Tour Confirmation</div><div class="template-preview">Tour confirmed at Iron 65...</div></div>
            <div class="template-card" onclick="useTemplate('followup')"><div class="template-name">&#x1F504; Follow-Up</div><div class="template-preview">Still looking for an apartment?</div></div>
            <div class="template-card" onclick="useTemplate('specials')"><div class="template-name">&#x1F389; Current Specials</div><div class="template-preview">Up to 2 months free...</div></div>
            <div class="template-card" onclick="useTemplate('cosigner')"><div class="template-name">&#x1F4B3; Cosigner Info</div><div class="template-preview">FREE cosigner via TheGuarantors</div></div>
            <div class="template-card" onclick="useTemplate('calendly')"><div class="template-name">&#x1F517; Book Tour Link</div><div class="template-preview">calendly.com/ana-rosaliagroup/...</div></div>
          </div></div>
          <div class="card mb-16"><div class="card-body">
            <div style="font-weight:700;margin-bottom:10px">Bulk SMS</div>
            <div class="form-group"><label class="form-label">Send to</label><select class="form-input" id="bulkTarget"><option>Hot Leads</option><option>New Leads</option><option>Touring This Week</option><option>All Leads</option></select></div>
            <div class="form-group"><label class="form-label">Template</label><select class="form-input"><option>Current Specials</option><option>Follow-Up</option><option>Book Tour</option></select></div>
            <button class="btn btn-primary" onclick="sendBulkSMS()" style="width:100%">&#x27A4; Send Bulk SMS</button>
          </div></div>
          <div class="card"><div class="card-body">
            <div style="font-weight:700;margin-bottom:10px">&#x1F4E7; Email</div>
            <div class="form-group"><label class="form-label">To</label><input type="email" class="form-input" id="emailTo" placeholder="lead@email.com"></div>
            <div class="form-group"><label class="form-label">Subject</label><input type="text" class="form-input" id="emailSubject" placeholder="Your Iron 65 Tour"></div>
            <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="emailBody" rows="4" placeholder="Write your email..."></textarea></div>
            <button class="btn btn-primary" onclick="sendEmail()" style="width:100%">&#x1F4E7; Send Email</button>
          </div></div>
        </div>
      </div>
    </div>

    <!-- ═══ TAB 4: ANALYTICS ═══ -->
    <div class="tab-panel" id="panel-analytics">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon green">&#x1F4B0;</div><div class="stat-value" id="stat-revenue">$0</div><div class="stat-label">Monthly Revenue</div></div>
        <div class="stat-card"><div class="stat-icon blue">&#x23F1;</div><div class="stat-value">4.2h</div><div class="stat-label">Lead-to-Tour</div></div>
        <div class="stat-card"><div class="stat-icon purple">&#x1F4C8;</div><div class="stat-value">52%</div><div class="stat-label">Tour-to-App</div></div>
        <div class="stat-card"><div class="stat-icon yellow">&#x1F4B2;</div><div class="stat-value">$12.40</div><div class="stat-label">Cost/Lead</div></div>
      </div>
      <div class="grid-2 mb-16">
        <div class="card"><div class="card-header"><h2>Calls This Week</h2></div><div class="card-body"><div class="chart-bar" id="callsChart"></div></div></div>
        <div class="card"><div class="card-header"><h2>SMS This Week</h2></div><div class="card-body"><div class="chart-bar" id="smsChart"></div></div></div>
      </div>
      <div class="grid-2">
        <div class="card"><div class="card-header"><h2>Pipeline Funnel</h2></div><div class="card-body" id="funnelChart"></div></div>
        <div class="card"><div class="card-header"><h2>Lead Sources</h2></div><div class="card-body" id="sourcesChart"></div></div>
      </div>
    </div>

    <!-- ═══ TAB 5: SETTINGS ═══ -->
    <div class="tab-panel" id="panel-settings">
      <div class="grid-2">
        <div>
          <div class="card mb-16"><div class="card-header"><h2>&#x1F517; Follow Up Boss API</h2></div><div class="card-body">
            <p style="font-size:13px;color:#6b7280;margin-bottom:14px;line-height:1.5">Enter your FUB API key from <a href="https://app.followupboss.com/2/api" target="_blank" style="color:#1a56db;font-weight:600">FUB Admin → API</a></p>
            <div class="form-group"><label class="form-label">FUB API Key</label><div style="display:flex;gap:6px"><input type="password" class="form-input" id="fubApiKey" placeholder="Your FUB API key" style="flex:1"><button class="btn btn-outline btn-sm" onclick="toggleVis('fubApiKey')">&#x1F441;</button></div></div>
            <div style="display:flex;gap:6px;margin-top:10px"><button class="btn btn-primary" onclick="saveFUBKey()">Save</button><button class="btn btn-outline" onclick="testFUBKey()">Test</button></div>
            <div id="fubKeyStatus" style="margin-top:10px;font-size:13px"></div>
          </div></div>
          <div class="card"><div class="card-header"><h2>&#x1F4DE; Twilio / VAPI</h2></div><div class="card-body">
            <div class="form-group"><label class="form-label">Twilio Status</label><div style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:#f59e0b"></span><span style="font-size:13px;color:#92400e;font-weight:600" id="twilioStatusText">Pending</span></div></div>
            <div class="form-group"><label class="form-label">VAPI Status</label><div style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:#10b981"></span><span style="font-size:13px;color:#047857;font-weight:600">Connected</span></div></div>
            <button class="btn btn-outline btn-sm" onclick="checkTwilioStatus()">Check Status</button>
          </div></div>
        </div>
        <div>
          <div class="card mb-16"><div class="card-header"><h2>&#x1F3E2; Property</h2></div><div class="card-body">
            <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="sPropName" value="Iron 65"></div>
            <div class="form-group"><label class="form-label">Address</label><input class="form-input" id="sPropAddr" value="65 McWhorter St, Newark NJ 07105"></div>
            <div class="form-group"><label class="form-label">Calendly</label><input class="form-input" id="sCalendly" value="https://calendly.com/ana-rosaliagroup/65-iron-tour"></div>
            <div class="form-group"><label class="form-label">Cosigner Link</label><input class="form-input" id="sCosigner" value="https://app.theguarantors.com/referral/sign-up/ad295b820fb11b34ee2f5cc96f1acf659032ce4fd9280a9fa1f380582aeda1a2"></div>
            <button class="btn btn-primary" onclick="saveSettings('property')">Save</button>
          </div></div>
          <div class="card"><div class="card-header"><h2>&#x1F916; Aria Config</h2></div><div class="card-body">
            <div class="form-group"><label class="form-label">Greeting</label><textarea class="form-input" id="sGreeting" rows="2">Hi! This is Aria from Iron 65 in Newark. How are you?</textarea></div>
            <div class="form-group"><label class="form-label">Default Call Mode</label><select class="form-input" id="sCallMode"><option value="vapi">VAPI + Claude</option><option value="twilio">Twilio TwiML</option></select></div>
            <div class="form-group"><label class="form-label">Auto-SMS after call?</label><select class="form-input" id="sAutoSms"><option value="yes">Yes</option><option value="no">No</option></select></div>
            <button class="btn btn-primary" onclick="saveSettings('aria')">Save</button>
          </div></div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ═══ MODALS ═══ -->
<div class="modal-overlay" id="addLeadModal" onclick="if(event.target===this)closeModal(this.id)">
  <div class="modal">
    <div class="modal-title">Add New Lead</div>
    <div class="form-row"><div class="form-group"><label class="form-label">First Name *</label><input class="form-input" id="nlFirst" placeholder="John"></div><div class="form-group"><label class="form-label">Last Name *</label><input class="form-input" id="nlLast" placeholder="Smith"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Phone *</label><input class="form-input" id="nlPhone" placeholder="(555) 123-4567"></div><div class="form-group"><label class="form-label">Email</label><input class="form-input" id="nlEmail" placeholder="john@email.com"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Source</label><select class="form-input" id="nlSource"><option>Follow Up Boss</option><option>Zillow</option><option>Apartments.com</option><option>Website</option><option>Referral</option><option>Walk-in</option><option>Facebook</option><option>Instagram</option></select></div><div class="form-group"><label class="form-label">Status</label><select class="form-input" id="nlStatus"><option value="new">New</option><option value="hot">Hot</option><option value="contacted">Contacted</option><option value="touring">Touring</option></select></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Budget</label><select class="form-input" id="nlBudget"><option value="">Select...</option><option>$2,000-$2,500</option><option>$2,500-$3,000</option><option>$3,000-$3,500</option><option>$3,500+</option></select></div><div class="form-group"><label class="form-label">Move Date</label><input type="date" class="form-input" id="nlMoveDate"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Income</label><select class="form-input" id="nlIncome"><option value="">Select...</option><option>Under $60k</option><option>$60k-$80k</option><option>$80k-$100k</option><option>$100k-$120k</option><option>$120k+</option></select></div><div class="form-group"><label class="form-label">Credit</label><select class="form-input" id="nlCredit"><option value="">Select...</option><option>Excellent (750+)</option><option>Good (700-749)</option><option>Fair (650-699)</option><option>Building (Below 650)</option></select></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Location Preference</label><input class="form-input" id="nlLocation" placeholder="Ironbound, Downtown..."></div><div class="form-group"><label class="form-label">Apartment Size</label><select class="form-input" id="nlSize"><option value="">Select...</option><option>Studio</option><option>1 Bedroom</option><option>1 BR Flex</option><option>2 Bedroom</option><option>Loft</option></select></div></div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="nlNotes" rows="2" placeholder="Additional info about this lead..."></textarea></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Book Appointment?</label><select class="form-input" id="nlAppt" onchange="document.getElementById('apptFields').style.display=this.value==='yes'?'block':'none'"><option value="no">No</option><option value="yes">Yes — Schedule Tour</option></select></div><div></div></div>
    <div id="apptFields" style="display:none;border-top:1px solid #e5e7eb;padding-top:12px;margin-top:4px">
      <div class="form-row"><div class="form-group"><label class="form-label">Tour Date</label><input type="date" class="form-input" id="nlTourDate"></div><div class="form-group"><label class="form-label">Tour Time</label><select class="form-input" id="nlTourTime"><option>10:00 AM</option><option>11:00 AM</option><option>12:00 PM</option><option>1:00 PM</option><option>2:00 PM</option><option>3:00 PM</option><option>4:00 PM</option><option>5:00 PM</option></select></div></div>
    </div>
    <div class="modal-actions"><button class="btn btn-outline" onclick="closeModal('addLeadModal')">Cancel</button><button class="btn btn-primary" onclick="addNewLead()">Add Lead</button></div>
  </div>
</div>

<div class="modal-overlay" id="scheduleModal" onclick="if(event.target===this)closeModal(this.id)">
  <div class="modal">
    <div class="modal-title">Schedule Auto-Calls</div>
    <p style="font-size:13px;color:#6b7280;margin-bottom:14px">Aria will automatically call leads during your business hours.</p>
    <div style="background:#eff6ff;border:1px solid #dbeafe;border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.6">
      <div style="font-weight:700;color:#1a56db;margin-bottom:6px">&#x1F4C5; Default Call Hours</div>
      <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px">
        <span style="font-weight:600">Mon–Fri:</span><span>9:00 AM – 6:00 PM</span>
        <span style="font-weight:600">Saturday:</span><span>10:00 AM – 6:00 PM</span>
        <span style="font-weight:600">Sunday:</span><span>11:00 AM – 5:00 PM</span>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Target Group</label><select class="form-input" id="schedTarget"><option value="hot">Hot Leads</option><option value="new">New Leads (Uncontacted)</option><option value="cold">Cold Leads (Follow-up)</option><option value="all">All Leads</option></select></div>
    <div class="form-group"><label class="form-label">Schedule Type</label><select class="form-input" id="schedType" onchange="document.getElementById('schedOnceFields').style.display=this.value==='once'?'grid':'none';document.getElementById('schedRecurFields').style.display=this.value==='recurring'?'block':'none'"><option value="recurring">Recurring (Weekly)</option><option value="once">One-Time</option></select></div>
    <div class="form-row" id="schedOnceFields" style="display:none"><div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="schedDate"></div><div class="form-group"><label class="form-label">Start Time</label><select class="form-input" id="schedTime"><option>9:00 AM</option><option>10:00 AM</option><option>11:00 AM</option><option>12:00 PM</option><option>1:00 PM</option><option>2:00 PM</option><option>3:00 PM</option><option>4:00 PM</option><option>5:00 PM</option></select></div></div>
    <div id="schedRecurFields">
      <div class="form-group"><label class="form-label">Active Days</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay1" checked> Mon</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay2" checked> Tue</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay3" checked> Wed</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay4" checked> Thu</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay5" checked> Fri</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay6" checked> Sat</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer"><input type="checkbox" id="sDay0" checked> Sun</label>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="schedStartDate"></div>
    </div>
    <div class="form-group"><label class="form-label">Call Mode</label><select class="form-input" id="schedMode"><option value="vapi">VAPI + Claude AI</option><option value="twilio">Twilio TwiML</option></select></div>
    <div class="form-group"><label class="form-label">Minutes between calls</label><select class="form-input" id="schedGap"><option value="3">3 minutes</option><option value="5" selected>5 minutes</option><option value="10">10 minutes</option></select></div>
    <div class="modal-actions"><button class="btn btn-outline" onclick="closeModal('scheduleModal')">Cancel</button><button class="btn btn-primary" onclick="scheduleAutoCalls()">Schedule Calls</button></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const API='/.netlify/functions';
const EP_FN={aiCall:API+'/ai-call-iron65',fubLeads:API+'/fub-leads',sendTourSms:API+'/send-tour-sms',vapiCall:API+'/vapi-call-iron65'};
let leads=[],filteredLeads=[],selectedLead=null,selectedConvo=null,callTimerInt=null,callSec=0,currentFilter='all',schedules=[
  {type:'recurring',target:'all',days:['Mon','Tue','Wed','Thu','Fri'],startDate:'2026-02-23',count:0,mode:'vapi',gap:'5',hours:'9:00 AM – 6:00 PM',active:true,label:'Mon–Fri 9AM–6PM'},
  {type:'recurring',target:'all',days:['Sat'],startDate:'2026-02-28',count:0,mode:'vapi',gap:'5',hours:'10:00 AM – 6:00 PM',active:true,label:'Saturday 10AM–6PM'},
  {type:'recurring',target:'all',days:['Sun'],startDate:'2026-03-01',count:0,mode:'vapi',gap:'5',hours:'11:00 AM – 5:00 PM',active:true,label:'Sunday 11AM–5PM'}
];

const convos=[
  {id:1,name:'Marcus Johnson',phone:'(973) 555-0142',color:'#1a56db',msgs:[{from:'aria',text:'Hi Marcus! Aria from Iron 65. 1BR units from $2,700/mo — 1 month FREE! Tour this weekend?',time:'2:30 PM'},{from:'lead',text:'Yeah, Saturday works!',time:'2:35 PM'}]},
  {id:2,name:'Priya Patel',phone:'(201) 555-0198',color:'#8b5cf6',msgs:[{from:'aria',text:'Tour confirmed Sunday 11 AM. 65 McWhorter St, Newark NJ',time:'1:20 PM'},{from:'lead',text:'Perfect, thanks!',time:'1:25 PM'}]},
  {id:3,name:'David Chen',phone:'(862) 555-0167',color:'#10b981',msgs:[{from:'aria',text:'Studios from $2,388/mo — gym, sauna, rooftop. 1 month FREE!',time:'12:50 PM'}]}
];

const sampleLeads=[
  {id:1,name:'Marcus Johnson',phone:'(973) 555-0142',email:'marcus.j@gmail.com',source:'Zillow',status:'hot',budget:'$2,500-$3,000',moveDate:'2026-03-15',income:'$80k-$100k',credit:'Good',location:'Ironbound',size:'1BR',notes:'Very interested, wants parking info',last:'2 hours ago'},
  {id:2,name:'Priya Patel',phone:'(201) 555-0198',email:'priya.patel@yahoo.com',source:'Apartments.com',status:'touring',budget:'$3,000-$3,500',moveDate:'2026-04-01',income:'$100k-$120k',credit:'Excellent',location:'Downtown',size:'1BR Flex',notes:'Tour Sunday 11 AM',last:'Yesterday'},
  {id:3,name:'David Chen',phone:'(862) 555-0167',email:'dchen@outlook.com',source:'FUB',status:'new',budget:'$2,000-$2,500',moveDate:'2026-03-01',income:'$60k-$80k',credit:'Good',location:'',size:'Studio',notes:'',last:'Just now'},
  {id:4,name:'Sarah Williams',phone:'(908) 555-0134',email:'swilliams@gmail.com',source:'Website',status:'contacted',budget:'$3,500+',moveDate:'2026-05-01',income:'$120k+',credit:'Excellent',location:'Lincoln Park',size:'2BR',notes:'Wants duplex',last:'3 hours ago'},
  {id:5,name:'James Rodriguez',phone:'(973) 555-0189',email:'jrod@email.com',source:'Referral',status:'hot',budget:'$2,500-$3,000',moveDate:'2026-03-15',income:'$80k-$100k',credit:'Fair',location:'Ironbound',size:'1BR',notes:'Referred by Marcus J',last:'1 hour ago'},
  {id:6,name:'Aisha Thompson',phone:'(201) 555-0145',email:'aisha.t@gmail.com',source:'Zillow',status:'new',budget:'$2,000-$2,500',moveDate:'2026-04-15',income:'$60k-$80k',credit:'Building',location:'',size:'Studio',notes:'First apartment',last:'30 min ago'},
  {id:7,name:'Michael Park',phone:'(862) 555-0112',email:'mpark@yahoo.com',source:'FUB',status:'closed',budget:'$3,000-$3,500',moveDate:'2026-02-01',income:'$100k-$120k',credit:'Excellent',location:'',size:'1BR Flex',notes:'Signed 12mo lease',last:'2 days ago'},
  {id:8,name:'Lisa Nguyen',phone:'(973) 555-0178',email:'lisa.n@gmail.com',source:'Apartments.com',status:'cold',budget:'$2,500-$3,000',moveDate:'',income:'',credit:'',location:'',size:'1BR',notes:'Not responding',last:'5 days ago'},
  {id:9,name:'Robert Kim',phone:'(201) 555-0156',email:'rkim@outlook.com',source:'Walk-in',status:'touring',budget:'$3,500+',moveDate:'2026-03-01',income:'$120k+',credit:'Excellent',location:'',size:'Loft',notes:'Tour today 2 PM',last:'Today'},
  {id:10,name:'Emily Davis',phone:'(908) 555-0123',email:'emily.d@gmail.com',source:'Website',status:'hot',budget:'$2,500-$3,000',moveDate:'2026-04-01',income:'$80k-$100k',credit:'Good',location:'',size:'1BR',notes:'Has dog, asked about pet policy',last:'4 hours ago'}
];

function init(){
  leads=sampleLeads.slice();filteredLeads=leads.slice();
  renderLeads();updateStats();updateDialerDropdown();renderSchedule();renderCallLog();renderConvos();renderCharts();renderFunnel();renderSources();loadSettings();
  // Auto-sync FUB on load
  syncFUBLeads(true);
}

function switchTab(t){document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.tab-panel').forEach(e=>e.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');document.getElementById('panel-'+t).classList.add('active')}
function getColor(s){return{hot:'#ef4444',new:'#1a56db',contacted:'#f59e0b',touring:'#8b5cf6',closed:'#10b981',cold:'#9ca3af',warm:'#f59e0b'}[s]||'#6b7280'}
function initials(n){return n.split(' ').map(w=>w[0]).join('').toUpperCase()}
function cap(s){return s?s[0].toUpperCase()+s.slice(1):''}
function timeAgo(d){if(!d)return '—';const s=Math.floor((new Date()-new Date(d))/1000);if(s<60)return 'Just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}

function updateStats(){
  const tot=leads.length,hot=leads.filter(l=>l.status==='hot').length,tour=leads.filter(l=>l.status==='touring').length,closed=leads.filter(l=>l.status==='closed').length;
  document.getElementById('stat-total').textContent=tot;document.getElementById('stat-hot').textContent=hot;document.getElementById('stat-tours').textContent=tour;document.getElementById('stat-leases').textContent=closed;
  document.getElementById('qa-hot').textContent=hot+' leads';document.getElementById('qa-new').textContent=leads.filter(l=>l.status==='new').length+' leads';
  document.getElementById('stat-revenue').textContent='$'+(closed*2696).toLocaleString();
}

function renderLeads(){
  const tb=document.getElementById('leadsTable');
  if(!filteredLeads.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px;color:#9ca3af">No leads found. Click "Sync FUB" or "Add Lead".</td></tr>';return}
  tb.innerHTML=filteredLeads.map(l=>`<tr class="${selectedLead&&selectedLead.id===l.id?'selected':''}" onclick="selectLead(${l.id})">
    <td><div style="display:flex;align-items:center;gap:8px"><div style="width:30px;height:30px;border-radius:50%;background:${getColor(l.status)};color:white;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0">${initials(l.name)}</div><div><div style="font-weight:600;font-size:13px">${l.name}</div><div style="font-size:11px;color:#9ca3af">${l.email||''}</div></div></div></td>
    <td style="font-family:monospace;font-size:12px">${l.phone||'—'}</td><td style="font-size:12px">${l.source||'—'}</td>
    <td><span class="badge badge-${l.status}">${cap(l.status)}</span></td><td style="font-size:12px">${l.budget||'—'}</td><td style="font-size:12px">${l.moveDate||'—'}</td><td style="font-size:12px;color:#6b7280">${l.last||'—'}</td>
    <td onclick="event.stopPropagation()"><div style="display:flex;gap:3px">
      <button class="btn-icon" title="Call" onclick="selectForCall(${l.id})">&#x1F4DE;</button>
      <button class="btn-icon" title="SMS" onclick="selectForSMS(${l.id})">&#x1F4AC;</button>
      <button class="btn-icon" title="Tour SMS" onclick="sendTourSMS(${l.id})">&#x1F4C5;</button>
      <button class="btn-icon" title="Email" onclick="emailLead(${l.id})">&#x1F4E7;</button>
    </div></td></tr>`).join('')}

function selectLead(id){
  const l=leads.find(x=>x.id===id);if(!l)return;selectedLead=l;renderLeads();
  document.getElementById('leadDetailPanel').innerHTML=`<div class="lead-detail"><h3>${l.name}</h3>
    <div class="lead-detail-row"><span class="lead-detail-label">Phone</span><span class="lead-detail-value">${l.phone||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Email</span><span class="lead-detail-value">${l.email||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Source</span><span class="lead-detail-value">${l.source||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Status</span><span class="lead-detail-value"><span class="badge badge-${l.status}">${cap(l.status)}</span></span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Budget</span><span class="lead-detail-value">${l.budget||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Move Date</span><span class="lead-detail-value">${l.moveDate||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Income</span><span class="lead-detail-value">${l.income||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Credit</span><span class="lead-detail-value">${l.credit||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Location Pref</span><span class="lead-detail-value">${l.location||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Apt Size</span><span class="lead-detail-value">${l.size||'—'}</span></div>
    <div class="lead-detail-row"><span class="lead-detail-label">Notes</span><span class="lead-detail-value">${l.notes||'—'}</span></div>
    <div class="lead-detail-actions">
      <button class="btn btn-primary btn-sm" onclick="selectForCall(${l.id})">&#x1F4DE; Call</button>
      <button class="btn btn-success btn-sm" onclick="selectForSMS(${l.id})">&#x1F4AC; Text</button>
      <button class="btn btn-outline btn-sm" onclick="sendTourSMS(${l.id})">&#x1F4C5; Tour SMS</button>
      <button class="btn btn-outline btn-sm" onclick="emailLead(${l.id})">&#x1F4E7; Email</button>
      <button class="btn btn-outline btn-sm" onclick="bookAppt(${l.id})">&#x1F4C5; Book Tour</button>
    </div></div>`}

function searchLeads(q){q=q.toLowerCase();filteredLeads=leads.filter(l=>(l.name+' '+l.phone+' '+l.email+' '+l.source+' '+l.notes).toLowerCase().includes(q));if(currentFilter!=='all')filteredLeads=filteredLeads.filter(l=>l.status===currentFilter);renderLeads()}
function filterLeads(f){currentFilter=f;document.getElementById('leadFilter').value=f;applyFilter();document.querySelectorAll('.stat-card').forEach(c=>c.classList.remove('selected'));if(f!=='all')event?.target?.closest('.stat-card')?.classList.add('selected')}
function applyFilter(){const f=document.getElementById('leadFilter').value;currentFilter=f;const q=document.getElementById('leadSearch').value.toLowerCase();filteredLeads=leads.filter(l=>{if(f!=='all'&&l.status!==f)return false;if(q&&!(l.name+' '+l.phone+' '+l.email+' '+l.source).toLowerCase().includes(q))return false;return true});renderLeads()}

function syncFUBLeads(silent){
  if(!silent)toast('Syncing FUB...');
  fetch(EP_FN.fubLeads).then(r=>r.json()).then(d=>{
    if(d.success&&d.leads&&d.leads.length){
      leads=d.leads.map((l,i)=>({id:l.id||i+1,name:l.name||'Unknown',phone:l.phone||'',email:l.email||'',source:l.source||'FUB',status:{hot:'hot',warm:'contacted',cold:'cold'}[l.score]||'new',budget:l.interest||'',moveDate:'',income:'',credit:'',location:'',size:'',notes:l.tags?.join(', ')||'',last:l.lastActivity?timeAgo(l.lastActivity):''}));
      filteredLeads=leads.slice();renderLeads();updateStats();updateDialerDropdown();
      if(!silent)toast('Synced '+d.total+' leads from FUB!','success');
    } else if(d.error){
      if(!silent)toast('FUB: '+d.error,'error');
      if(leads.length===0){leads=sampleLeads.slice();filteredLeads=leads.slice();renderLeads();updateStats()}
    } else {
      if(!silent)toast('No leads in FUB','warning');
    }
  }).catch(e=>{
    if(!silent)toast('FUB sync failed — using sample data','warning');
    if(leads.length===0){leads=sampleLeads.slice();filteredLeads=leads.slice();renderLeads();updateStats()}
  });
}

function selectForCall(id){const l=leads.find(x=>x.id===id);if(!l)return;selectedLead=l;switchTab('calls');document.getElementById('dialerNumber').textContent=l.phone||'No phone';document.getElementById('dialerName').textContent=l.name;document.getElementById('dialerLeadSelect').value=id;toast('Ready to call '+l.name)}
function selectDialerLead(){const id=parseInt(document.getElementById('dialerLeadSelect').value);if(!id)return;const l=leads.find(x=>x.id===id);if(!l)return;selectedLead=l;document.getElementById('dialerNumber').textContent=l.phone||'No phone';document.getElementById('dialerName').textContent=l.name}
function updateDialerDropdown(){const sel=document.getElementById('dialerLeadSelect');if(!sel)return;const val=sel.value;sel.innerHTML='<option value="">-- Select a lead to call --</option>'+leads.map(l=>`<option value="${l.id}">${l.name} — ${l.phone||'no phone'}</option>`).join('');if(val)sel.value=val}
function selectForSMS(id){const l=leads.find(x=>x.id===id);if(!l)return;switchTab('sms');const c=convos.find(x=>x.name===l.name);if(c)openConvo(c.id);else{document.getElementById('chatName').textContent=l.name;document.getElementById('chatPhone').textContent=l.phone;document.getElementById('chatMessages').innerHTML='<div style="text-align:center;color:#9ca3af;font-size:13px;margin:auto">Start a conversation with '+l.name+'</div>'}toast('SMS to '+l.name)}
function emailLead(id){const l=leads.find(x=>x.id===id);if(!l)return;switchTab('sms');document.getElementById('emailTo').value=l.email||'';document.getElementById('emailSubject').value='Your Iron 65 Tour — '+l.name;document.getElementById('emailBody').value='Hi '+l.name+',\n\nThank you for your interest in Iron 65! I wanted to follow up regarding your apartment search.\n\nWe have beautiful units starting at $2,388/mo with amazing amenities including gym, sauna, rooftop, and in-unit W/D.\n\nCurrent specials:\n- 1 month FREE on 12-month lease\n- $4,000 credit on 18-month lease\n- 2 months FREE on 24-month lease\n\nWould you like to schedule a tour? Book here: https://calendly.com/ana-rosaliagroup/65-iron-tour\n\nBest,\nAna\nEmporion Pros | Iron 65';document.getElementById('emailTo').scrollIntoView({behavior:'smooth'});toast('Email ready for '+l.name)}
function bookAppt(id){const l=leads.find(x=>x.id===id);if(!l)return;window.open('https://calendly.com/ana-rosaliagroup/65-iron-tour','_blank');toast('Opening Calendly for '+l.name)}

function initiateAICall(){
  if(!selectedLead){toast('Select a lead first','warning');return}
  const mode=document.getElementById('callMode').value,ep=mode==='vapi'?EP_FN.vapiCall:EP_FN.aiCall;
  const st=document.getElementById('callStatus'),tm=document.getElementById('callTimer');
  st.textContent='Connecting...';st.className='call-status active';
  document.getElementById('callBtn').style.display='none';document.getElementById('hangupBtn').style.display='';
  tm.style.display='block';callSec=0;
  callTimerInt=setInterval(()=>{callSec++;tm.textContent=String(Math.floor(callSec/60)).padStart(2,'0')+':'+String(callSec%60).padStart(2,'0')},1000);
  fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leadName:selectedLead.name,leadPhone:(selectedLead.phone||'').replace(/\D/g,''),leadEmail:selectedLead.email,leadSource:selectedLead.source,leadId:selectedLead.id})})
  .then(r=>r.json()).then(d=>{if(d.success){st.textContent='Aria talking to '+selectedLead.name;toast('Calling '+selectedLead.name+'...','success')}else throw new Error(d.error||'Failed')})
  .catch(e=>{st.textContent='Failed: '+e.message;st.className='call-status';hangupCall();toast(e.message,'error')})}
function hangupCall(){clearInterval(callTimerInt);document.getElementById('callStatus').textContent='Ended — '+document.getElementById('callTimer').textContent;document.getElementById('callStatus').className='call-status';document.getElementById('callBtn').style.display='';document.getElementById('hangupBtn').style.display='none'}
function updateCallMode(){document.getElementById('callModeDesc').textContent={vapi:'VAPI with Claude AI + Deepgram Luna voice.',twilio:'Twilio TwiML with Amazon Polly.',manual:'Manual calls — no AI.'}[document.getElementById('callMode').value]}

function scheduleAutoCalls(){
  const target=document.getElementById('schedTarget').value,type=document.getElementById('schedType').value,mode=document.getElementById('schedMode').value,gap=document.getElementById('schedGap').value;
  const count=leads.filter(l=>target==='all'||l.status===target).length;
  const hours={weekday:'9:00 AM – 6:00 PM',saturday:'10:00 AM – 6:00 PM',sunday:'11:00 AM – 5:00 PM'};
  if(type==='recurring'){
    const days=[];
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach((d,i)=>{if(document.getElementById('sDay'+((i+1)%7)).checked)days.push(d)});
    const startDate=document.getElementById('schedStartDate').value||new Date().toISOString().split('T')[0];
    schedules.push({type:'recurring',target,days,startDate,count,mode,gap,hours});
    renderSchedule();closeModal('scheduleModal');
    toast('Recurring schedule set: '+days.join(', ')+' — '+count+' '+cap(target)+' leads every '+gap+' min','success');
  } else {
    const date=document.getElementById('schedDate').value,time=document.getElementById('schedTime').value;
    if(!date){toast('Select a date','warning');return}
    schedules.push({type:'once',target,date,time,count,mode,gap});
    renderSchedule();closeModal('scheduleModal');
    toast('Scheduled '+count+' calls for '+date+' at '+time,'success');
  }
}
function renderSchedule(){
  const el=document.getElementById('callSchedule');
  // Update lead counts in schedules
  schedules.forEach(s=>{s.count=leads.filter(l=>s.target==='all'||l.status===s.target).length});
  if(!schedules.length){el.innerHTML='<div style="color:#9ca3af;font-size:13px;text-align:center;padding:12px">No scheduled calls. Click + Schedule to set up auto-dialing.</div>';return}
  el.innerHTML=schedules.map((s,i)=>{
    if(s.type==='recurring'){
      const statusColor=s.active?'#10b981':'#f59e0b';
      const statusText=s.active?'Active':'Paused';
      return `<div class="schedule-item" style="flex-wrap:wrap;border-color:${s.active?'#d1fae5':'#e5e7eb'}">
        <div style="width:8px;height:8px;border-radius:50%;background:${statusColor};flex-shrink:0;${s.active?'animation:pulse 2s infinite':''}"></div>
        <div style="flex:1"><div class="schedule-name">${s.label||s.days.join(', ')}</div><div class="schedule-status">${s.count} leads · Every ${s.gap} min · ${s.mode.toUpperCase()}</div></div>
        <div style="display:flex;gap:4px;align-items:center">
          <button class="btn btn-sm ${s.active?'btn-success':'btn-outline'}" onclick="schedules[${i}].active=!schedules[${i}].active;renderSchedule();toast(schedules[${i}].active?'Schedule activated':'Schedule paused','success')">${statusText}</button>
          <button class="btn-icon" onclick="schedules.splice(${i},1);renderSchedule();toast('Removed','info')">&#x274C;</button>
        </div></div>`;
    } else {
      return `<div class="schedule-item"><div class="schedule-time">${s.time}</div><div style="flex:1"><div class="schedule-name">${cap(s.target)} leads (${s.count})</div><div class="schedule-status">${s.date} · ${s.mode.toUpperCase()}</div></div><button class="btn-icon" onclick="schedules.splice(${i},1);renderSchedule()">&#x274C;</button></div>`;
    }
  }).join('')}

function renderCallLog(){
  const logs=[{name:'Marcus Johnson',type:'outgoing',dur:'3:24',time:'2:30 PM',result:'Tour booked Sat'},{name:'Priya Patel',type:'outgoing',dur:'5:12',time:'1:15 PM',result:'Sending info'},{name:'David Chen',type:'missed',dur:'0:00',time:'12:45 PM',result:'No answer'},{name:'Emily Davis',type:'outgoing',dur:'2:48',time:'11:30 AM',result:'Booking tour'},{name:'James Rodriguez',type:'incoming',dur:'1:56',time:'10:00 AM',result:'1BR pricing'}];
  document.getElementById('stat-calls').textContent=logs.length;document.getElementById('stat-avgdur').textContent='2:34';document.getElementById('stat-answer').textContent='68%';document.getElementById('stat-booking').textContent='41%';
  document.getElementById('callLog').innerHTML=logs.map(c=>`<div class="call-log-item"><div class="call-log-icon ${c.type}">${c.type==='missed'?'&#x274C;':'&#x1F4DE;'}</div><div style="flex:1"><div class="call-log-name">${c.name}</div><div class="call-log-detail">${c.result}</div></div><div><div class="call-log-time">${c.time}</div><div class="call-log-duration">${c.dur}</div></div></div>`).join('')}

function renderConvos(){
  document.getElementById('stat-smssent').textContent='156';document.getElementById('stat-delivery').textContent='94%';document.getElementById('stat-response').textContent='38%';document.getElementById('stat-smstours').textContent='14';
  document.getElementById('smsContactList').innerHTML=convos.map(c=>`<div class="sms-contact ${selectedConvo===c.id?'active':''}" onclick="openConvo(${c.id})"><div class="sms-contact-av" style="background:${c.color}">${initials(c.name)}</div><div style="flex:1;min-width:0"><div class="sms-contact-name">${c.name}</div><div class="sms-contact-preview">${c.msgs[c.msgs.length-1].text.substring(0,30)}...</div></div></div>`).join('')}
function openConvo(id){selectedConvo=id;const c=convos.find(x=>x.id===id);if(!c)return;document.getElementById('chatName').textContent=c.name;document.getElementById('chatPhone').textContent=c.phone;const el=document.getElementById('chatMessages');el.innerHTML=c.msgs.map(m=>`<div class="sms-msg ${m.from==='aria'?'sent':'received'}">${m.text}<div class="sms-msg-time">${m.time}</div></div>`).join('');el.scrollTop=el.scrollHeight;renderConvos()}

function sendSMS(){const el=document.getElementById('smsInput'),t=el.value.trim();if(!t||!selectedConvo)return;const c=convos.find(x=>x.id===selectedConvo);if(!c)return;c.msgs.push({from:'aria',text:t,time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})});el.value='';openConvo(selectedConvo);toast('Sent')}
function sendTourSMS(id){const l=leads.find(x=>x.id===id);if(!l||!l.phone)return;toast('Sending tour SMS to '+l.name+'...');
  fetch(EP_FN.sendTourSms,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:'+1'+(l.phone||'').replace(/\D/g,''),name:l.name,email:l.email,tourDay:'Saturday',tourTime:'11:00 AM',needsCosigner:false})})
  .then(r=>r.json()).then(d=>{if(d.success)toast('Tour SMS sent!','success');else throw new Error(d.error)}).catch(e=>toast('SMS: '+e.message,'error'))}
function sendEmail(){const to=document.getElementById('emailTo').value,subj=document.getElementById('emailSubject').value,body=document.getElementById('emailBody').value;if(!to){toast('Enter email address','warning');return}window.open('mailto:'+to+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body));toast('Opening email client')}
function emailFromChat(){const c=convos.find(x=>x.id===selectedConvo);if(!c)return;const l=leads.find(x=>x.name===c.name);if(l)emailLead(l.id)}

function useTemplate(t){const tpl={tour:'Hi {name}! Tour confirmed at Iron 65.\n65 McWhorter St, Newark NJ 07105\nReschedule: calendly.com/ana-rosaliagroup/65-iron-tour',followup:'Hi {name}, Aria from Iron 65! Still interested in luxury apartments in Newark?',specials:'Iron 65 specials:\n1 month FREE (12-mo)\n$4,000 credit (18-mo)\n2 months FREE (24-mo)\nBook: calendly.com/ana-rosaliagroup/65-iron-tour',cosigner:'Need a cosigner? FREE pre-approval:\napp.theguarantors.com/referral/sign-up/ad295b820fb11b34ee2f5cc96f1acf659032ce4fd9280a9fa1f380582aeda1a2',calendly:'Book your Iron 65 tour:\ncalendly.com/ana-rosaliagroup/65-iron-tour'};document.getElementById('smsInput').value=tpl[t]||'';document.getElementById('smsInput').focus();toast('Template loaded')}
function sendBulkSMS(){toast('Sending bulk SMS...');setTimeout(()=>toast('Bulk SMS queued!','success'),1500)}
function callFromChat(){if(!selectedConvo)return;const c=convos.find(x=>x.id===selectedConvo);if(c){const l=leads.find(x=>x.name===c.name);if(l)selectForCall(l.id)}}
function filterConvos(q){q=q.toLowerCase();document.querySelectorAll('.sms-contact').forEach(e=>{e.style.display=e.querySelector('.sms-contact-name').textContent.toLowerCase().includes(q)?'':'none'})}
function bulkAction(t){toast({hot:'Calling hot leads...',new:'New lead blitz...',follow:'Follow-up campaign...',rec:'Opening recordings...'}[t])}

function addNewLead(){
  const first=document.getElementById('nlFirst').value,last=document.getElementById('nlLast').value,phone=document.getElementById('nlPhone').value;
  if(!first||!last){toast('Name required','warning');return}
  const nl={id:Date.now(),name:first+' '+last,phone:phone,email:document.getElementById('nlEmail').value,source:document.getElementById('nlSource').value,status:document.getElementById('nlStatus').value,budget:document.getElementById('nlBudget').value,moveDate:document.getElementById('nlMoveDate').value,income:document.getElementById('nlIncome').value,credit:document.getElementById('nlCredit').value,location:document.getElementById('nlLocation').value,size:document.getElementById('nlSize').value,notes:document.getElementById('nlNotes').value,last:'Just now'};
  leads.unshift(nl);filteredLeads=leads.slice();renderLeads();updateStats();closeModal('addLeadModal');toast(nl.name+' added!','success');
  if(document.getElementById('nlAppt').value==='yes'){const td=document.getElementById('nlTourDate').value,tt=document.getElementById('nlTourTime').value;if(td)toast('Tour booked for '+td+' at '+tt,'success')}
}

function renderCharts(){renderBar('callsChart',[{l:'Mon',v:6},{l:'Tue',v:9},{l:'Wed',v:5},{l:'Thu',v:12},{l:'Fri',v:8},{l:'Sat',v:3},{l:'Sun',v:1}],'#1a56db');renderBar('smsChart',[{l:'Mon',v:18},{l:'Tue',v:24},{l:'Wed',v:15},{l:'Thu',v:32},{l:'Fri',v:22},{l:'Sat',v:8},{l:'Sun',v:5}],'#10b981')}
function renderBar(id,data,color){const mx=Math.max(...data.map(d=>d.v));document.getElementById(id).innerHTML=data.map(d=>`<div class="chart-col"><div class="chart-bar-value">${d.v}</div><div class="chart-bar-fill" style="height:${(d.v/mx)*100}px;background:${color}"></div><div class="chart-bar-label">${d.l}</div></div>`).join('')}
function renderFunnel(){const s=[{n:'Leads',v:47,p:100,c:'#1a56db'},{n:'Contacted',v:35,p:74,c:'#1a56db'},{n:'Qualified',v:22,p:47,c:'#8b5cf6'},{n:'Tours',v:14,p:30,c:'#f59e0b'},{n:'Apps',v:5,p:11,c:'#10b981'},{n:'Leases',v:3,p:6,c:'#047857'}];document.getElementById('funnelChart').innerHTML=s.map(x=>`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><div style="width:70px;font-size:11px;font-weight:500;color:#6b7280;text-align:right">${x.n}</div><div style="flex:1;height:24px;background:#f3f4f6;border-radius:4px;overflow:hidden"><div style="width:${x.p}%;height:100%;background:${x.c};border-radius:4px;display:flex;align-items:center;padding-left:6px"><span style="font-size:10px;font-weight:700;color:white">${x.v}</span></div></div><div style="width:32px;font-size:11px;font-weight:600;color:#6b7280">${x.p}%</div></div>`).join('')}
function renderSources(){const s=[{n:'Zillow',v:14,p:30,c:'#1a56db'},{n:'Apartments.com',v:11,p:23,c:'#8b5cf6'},{n:'FUB',v:9,p:19,c:'#10b981'},{n:'Website',v:7,p:15,c:'#f59e0b'},{n:'Referral',v:4,p:9,c:'#f97316'},{n:'Walk-in',v:2,p:4,c:'#9ca3af'}];document.getElementById('sourcesChart').innerHTML=s.map(x=>`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="width:8px;height:8px;border-radius:50%;background:${x.c}"></div><div style="flex:1"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="font-size:12px;font-weight:600">${x.n}</span><span style="font-size:11px;color:#6b7280">${x.v} (${x.p}%)</span></div><div style="height:5px;background:#f3f4f6;border-radius:3px;overflow:hidden"><div style="width:${x.p}%;height:100%;background:${x.c};border-radius:3px"></div></div></div></div>`).join('')}

// Settings
function saveFUBKey(){const k=document.getElementById('fubApiKey').value.trim();if(!k){toast('Enter key','warning');return}localStorage.setItem('ep_fub_key',k);document.getElementById('fubKeyStatus').innerHTML='<span style="color:#10b981">&#x2705; Saved</span>';toast('Key saved','success')}
function testFUBKey(){toast('Testing...');fetch(EP_FN.fubLeads).then(r=>r.json()).then(d=>{if(d.success){document.getElementById('fubKeyStatus').innerHTML='<span style="color:#10b981">&#x2705; Connected — '+d.total+' leads</span>';toast('Connected!','success')}else{document.getElementById('fubKeyStatus').innerHTML='<span style="color:#ef4444">&#x274C; '+d.error+'</span>';toast(d.error,'error')}}).catch(()=>{document.getElementById('fubKeyStatus').innerHTML='<span style="color:#ef4444">&#x274C; Failed</span>';toast('Failed','error')})}
function toggleVis(id){const e=document.getElementById(id);e.type=e.type==='password'?'text':'password'}
function saveSettings(type){if(type==='property')localStorage.setItem('ep_prop',JSON.stringify({name:document.getElementById('sPropName').value,addr:document.getElementById('sPropAddr').value,cal:document.getElementById('sCalendly').value,cos:document.getElementById('sCosigner').value}));if(type==='aria')localStorage.setItem('ep_aria',JSON.stringify({greeting:document.getElementById('sGreeting').value,mode:document.getElementById('sCallMode').value,auto:document.getElementById('sAutoSms').value}));toast('Settings saved!','success')}
function loadSettings(){const k=localStorage.getItem('ep_fub_key');if(k)document.getElementById('fubApiKey').value=k;const p=localStorage.getItem('ep_prop');if(p){const d=JSON.parse(p);if(d.name)document.getElementById('sPropName').value=d.name;if(d.addr)document.getElementById('sPropAddr').value=d.addr;if(d.cal)document.getElementById('sCalendly').value=d.cal;if(d.cos)document.getElementById('sCosigner').value=d.cos}const a=localStorage.getItem('ep_aria');if(a){const d=JSON.parse(a);if(d.greeting)document.getElementById('sGreeting').value=d.greeting;if(d.mode)document.getElementById('sCallMode').value=d.mode;if(d.auto)document.getElementById('sAutoSms').value=d.auto}}
function checkTwilioStatus(){toast('Checking...');setTimeout(()=>toast('Pending — 1-3 business days','warning'),1500)}
function openModal(id){document.getElementById(id).classList.add('show')}
function closeModal(id){document.getElementById(id).classList.remove('show')}
function toast(msg,type='info'){const c=document.getElementById('toastContainer');const t=document.createElement('div');t.className='toast'+(type==='error'?' error':type==='warning'?' warning':'');t.innerHTML=({'success':'&#x2705;','error':'&#x274C;','warning':'&#x26A0;','info':'&#x1F4AC;'}[type]||'&#x1F4AC;')+' '+msg;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='.3s';setTimeout(()=>t.remove(),300)},3500)}

document.addEventListener('DOMContentLoaded',()=>{init()});
</script>
</body>
</html>
