<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>FUB Integration â€” Emporion Pros</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="app.js"></script>
<style>
.dash{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 68px)}
.sidebar{background:white;border-right:1px solid #e5e7eb;padding:20px 0;position:sticky;top:68px;height:calc(100vh - 68px);overflow-y:auto}
.sidebar-av{width:52px;height:52px;border-radius:50%;background:#1a56db;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 20px;color:#374151;text-decoration:none;font-size:14px;font-weight:500;transition:.15s;cursor:pointer;background:none;border:none;width:100%;font-family:inherit}
.nav-item:hover,.nav-item.active{background:#eff6ff;color:#1a56db}
.dash-main{padding:28px;background:#f9fafb;overflow-y:auto}
.tab-content{display:none}.tab-content.active{display:block}

/* Hero banner */
.fub-hero{background:linear-gradient(135deg,#0f172a,#1a56db);border-radius:16px;padding:36px;color:white;margin-bottom:28px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:24px}
.fub-hero h1{font-size:28px;font-weight:800;margin-bottom:8px}
.fub-hero p{opacity:.85;font-size:15px;max-width:500px;line-height:1.6}
.fub-logo{background:rgba(255,255,255,.1);border-radius:12px;padding:16px 24px;font-size:22px;font-weight:800;letter-spacing:-1px}

/* Connection card */
.connect-card{background:white;border-radius:14px;padding:28px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:20px}
.connect-status{display:flex;align-items:center;gap:12px;padding:16px;border-radius:10px;margin-bottom:20px}
.connect-status.connected{background:#d1fae5;border:2px solid #10b981}
.connect-status.disconnected{background:#fef3c7;border:2px solid #f59e0b}
.status-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.dot-green{background:#10b981}
.dot-yellow{background:#f59e0b;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* Leads table */
.leads-table{width:100%;border-collapse:collapse}
.leads-table th{padding:10px 12px;text-align:left;font-size:12px;font-weight:700;color:#6b7280;text-transform:uppercase;border-bottom:2px solid #e5e7eb}
.leads-table td{padding:12px;border-bottom:1px solid #f3f4f6;font-size:14px;vertical-align:middle}
.leads-table tr:hover td{background:#f9fafb}
.ai-action-btn{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:600;border:none;cursor:pointer;font-family:inherit;transition:.2s}
.btn-call{background:#dbeafe;color:#1e40af}
.btn-call:hover{background:#1a56db;color:white}
.btn-text{background:#d1fae5;color:#065f46}
.btn-text:hover{background:#10b981;color:white}
.btn-email{background:#ede9fe;color:#4c1d95}
.btn-email:hover{background:#7c3aed;color:white}
.lead-score{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:white}
.score-hot{background:#ef4444}
.score-warm{background:#f59e0b}
.score-cold{background:#6b7280}

/* Pricing add-on */
.addon-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-top:20px}
.addon-card{border:2px solid #e5e7eb;border-radius:14px;padding:24px;transition:.2s;position:relative}
.addon-card.popular{border-color:#1a56db;background:#f0f7ff}
.popular-badge{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:#1a56db;color:white;padding:4px 16px;border-radius:20px;font-size:12px;font-weight:700;white-space:nowrap}
.addon-price{font-size:32px;font-weight:800;color:#1a56db;margin:8px 0}
.addon-feature{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:13px;border-bottom:1px solid #f3f4f6}
.addon-feature:last-of-type{border:none}

/* Activity feed */
.activity-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #f3f4f6}
.activity-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.activity-call{background:#dbeafe}
.activity-text{background:#d1fae5}
.activity-sync{background:#ede9fe}

/* Settings */
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid #f3f4f6}
.toggle{width:44px;height:24px;border-radius:12px;background:#e5e7eb;position:relative;cursor:pointer;transition:.2s;flex-shrink:0}
.toggle.on{background:#1a56db}
.toggle::after{content:'';position:absolute;width:18px;height:18px;background:white;border-radius:50%;top:3px;left:3px;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle.on::after{left:23px}

/* Call modal */
.call-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:600;align-items:center;justify-content:center}
.call-modal.open{display:flex}
.call-box{background:white;border-radius:20px;padding:36px;max-width:400px;width:100%;text-align:center}
.call-avatar{width:80px;height:80px;border-radius:50%;background:#1a56db;color:white;font-size:28px;font-weight:800;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.call-ring{animation:ring 1s infinite}
@keyframes ring{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.transcript-box{background:#f9fafb;border-radius:10px;padding:16px;margin:16px 0;text-align:left;max-height:180px;overflow-y:auto;font-size:13px}
.t-line{padding:4px 0;line-height:1.5}
.t-aria{color:#1a56db;font-weight:600}
.t-lead{color:#374151}

@media(max-width:900px){.dash{grid-template-columns:1fr}.sidebar{display:none}}
</style>
</head>
<body>
<div id="header-mount"></div>
<div class="dash">
  <aside class="sidebar">
    <div style="padding:16px 20px 20px;border-bottom:1px solid #e5e7eb;margin-bottom:8px">
      <div class="sidebar-av" id="fub-av">?</div>
      <div style="font-weight:700;font-size:15px" id="fub-name">Loading...</div>
      <div style="font-size:12px;color:#6b7280" id="fub-role">Agent Â· FUB Integration</div>
    </div>
    <button class="nav-item active" onclick="showTab('connect',this)">ğŸ”— Connect FUB</button>
    <button class="nav-item" onclick="showTab('leads',this)">ğŸ“¥ FUB Leads <span id="fub-badge" style="background:#ef4444;color:white;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px">0</span></button>
    <button class="nav-item" onclick="showTab('hot-leads',this)">ğŸ”¥ Hot Leads <span id="hot-badge" style="background:#ef4444;color:white;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px">0</span></button>
    <button class="nav-item" onclick="showTab('ai-actions',this)">ğŸ¤– AI Actions</button>
    <button class="nav-item" onclick="showTab('activity',this)">ğŸ“‹ Activity Log</button>
    <button class="nav-item" onclick="showTab('upgrade',this)">âš¡ Upgrade Plan</button>
    <button class="nav-item" onclick="showTab('settings',this)">âš™ï¸ Settings</button>
    <a href="agent-dashboard.html" class="nav-item">â† Back to Dashboard</a>
  </aside>

  <main class="dash-main">

    <!-- CONNECT -->
    <div class="tab-content active" id="tab-connect">
      <div class="fub-hero">
        <div>
          <div style="font-size:12px;font-weight:700;opacity:.7;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Emporion Pros Ã— Follow Up Boss</div>
          <h1>AI-Powered Lead Calling<br>for Your FUB Leads</h1>
          <p>Connect your Follow Up Boss account â†’ Emporion's AI calls and texts your leads within 5 minutes of them coming in. FUB doesn't offer this. We do.</p>
          <div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap">
            <div style="background:rgba(255,255,255,.15);border-radius:8px;padding:10px 16px;font-size:13px">âš¡ 5-min speed to lead</div>
            <div style="background:rgba(255,255,255,.15);border-radius:8px;padding:10px 16px;font-size:13px">ğŸ“ AI calls 24/7</div>
            <div style="background:rgba(255,255,255,.15);border-radius:8px;padding:10px 16px;font-size:13px">ğŸ’¬ Auto-text & email</div>
            <div style="background:rgba(255,255,255,.15);border-radius:8px;padding:10px 16px;font-size:13px">ğŸ“… Books appointments</div>
          </div>
        </div>
        <div class="fub-logo">FUB<br><span style="font-size:12px;font-weight:400;opacity:.7">Follow Up Boss</span></div>
      </div>

      <div class="connect-card">
        <h2 style="font-size:20px;font-weight:800;margin-bottom:6px">Step 1 â€” Connect Your FUB Account</h2>
        <p style="color:#6b7280;font-size:14px;margin-bottom:20px">Get your API key from Follow Up Boss: <strong>Admin â†’ API â†’ Copy API Key</strong></p>

        <div class="connect-status disconnected" id="connect-status">
          <div class="status-dot dot-yellow"></div>
          <div>
            <div style="font-weight:700">Not Connected</div>
            <div style="font-size:13px;color:#92400e">Enter your FUB API key below to connect</div>
          </div>
        </div>

        <div id="connect-form">
          <div class="ep-form-group">
            <label class="ep-label">Your Follow Up Boss API Key</label>
            <div style="display:flex;gap:10px">
              <input class="ep-input" id="fub-api-key" placeholder="fka_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="font-family:monospace">
              <button class="ep-btn ep-btn-primary" onclick="connectFUB()" style="white-space:nowrap">Connect FUB â†’</button>
            </div>
            <p style="font-size:12px;color:#6b7280;margin-top:8px">ğŸ”’ Your API key is stored securely and never shared. <a href="https://app.followupboss.com" target="_blank" style="color:#1a56db">Get my API key â†’</a></p>
          </div>
        </div>
        <div id="connected-msg" style="display:none">
          <div style="background:#d1fae5;border-radius:10px;padding:16px;display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:700;color:#065f46">âœ… Connected to Follow Up Boss</div>
            <div style="font-size:13px;color:#065f46">Syncing leads every 5 minutes</div></div>
            <button class="ep-btn ep-btn-outline" style="font-size:12px" onclick="disconnectFUB()">Disconnect</button>
          </div>
        </div>
      </div>

      <div class="connect-card">
        <h2 style="font-size:20px;font-weight:800;margin-bottom:6px">Step 2 â€” Enable AI Actions</h2>
        <p style="color:#6b7280;font-size:14px;margin-bottom:20px">Choose what Aria does automatically when a new lead comes in from FUB</p>
        <div class="setting-row">
          <div><div style="font-weight:600">ğŸ“ AI Phone Call</div><div style="font-size:13px;color:#6b7280">Aria calls the lead within 5 minutes, introduces herself as your assistant, and tries to book a showing</div></div>
          <div class="toggle on" id="toggle-call" onclick="toggleSetting(this,'call')"></div>
        </div>
        <div class="setting-row">
          <div><div style="font-weight:600">ğŸ’¬ AI Text Message</div><div style="font-size:13px;color:#6b7280">Sends a personalized text immediately â€” "Hi [Name], I saw you were looking at homes in Newark..."</div></div>
          <div class="toggle on" id="toggle-text" onclick="toggleSetting(this,'text')"></div>
        </div>
        <div class="setting-row">
          <div><div style="font-weight:600">ğŸ“§ AI Email Follow-up</div><div style="font-size:13px;color:#6b7280">Sends a personal email with property recommendations based on their search criteria</div></div>
          <div class="toggle on" id="toggle-email" onclick="toggleSetting(this,'email')"></div>
        </div>
        <div class="setting-row">
          <div><div style="font-weight:600">ğŸ”„ Push Updates Back to FUB</div><div style="font-size:13px;color:#6b7280">When Aria books an appointment or gets a response, update the lead status in Follow Up Boss automatically</div></div>
          <div class="toggle on" id="toggle-sync" onclick="toggleSetting(this,'sync')"></div>
        </div>
        <div class="setting-row" style="border:none">
          <div><div style="font-weight:600">â±ï¸ Call Timing</div><div style="font-size:13px;color:#6b7280">How quickly should Aria call after a new lead arrives?</div></div>
          <select class="ep-select" style="width:auto">
            <option>Immediately (within 1 min)</option>
            <option selected>Within 5 minutes</option>
            <option>Within 15 minutes</option>
            <option>Within 1 hour</option>
            <option>Business hours only</option>
          </select>
        </div>
        <button class="ep-btn ep-btn-primary" style="margin-top:16px;padding:12px 28px" onclick="EP.notify('Settings saved! Aria is ready to work ğŸ¤–','success')">Save Settings âœ“</button>
      </div>

      <div class="connect-card">
        <h2 style="font-size:20px;font-weight:800;margin-bottom:6px">Step 3 â€” Test It</h2>
        <p style="color:#6b7280;font-size:14px;margin-bottom:16px">Send a test lead to see exactly how Aria responds</p>
        <button class="ep-btn ep-btn-primary" onclick="sendTestLead()">ğŸ§ª Send Test Lead</button>
        <button class="ep-btn ep-btn-outline" style="margin-left:10px" onclick="showTab('activity',document.querySelectorAll('.nav-item')[3])">View Activity Log</button>
      </div>
    </div>

    <!-- FUB LEADS -->
    <div class="tab-content" id="tab-leads">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <h1 style="font-size:24px;font-weight:800">FUB Leads â€” AI Ready</h1>
        <div style="display:flex;gap:10px">
          <button class="ep-btn ep-btn-outline" onclick="openUploadModal()">ğŸ“¤ Upload Excel</button>
          <button class="ep-btn ep-btn-outline" onclick="syncFUBLeads()">ğŸ”„ Sync Now</button>
          <button class="ep-btn ep-btn-primary" onclick="callAllNew()">ğŸ“ Call All New Leads</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px">
        <div style="background:white;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)"><div style="font-size:24px;font-weight:800;color:#1a56db" id="stat-total">0</div><div style="font-size:12px;color:#6b7280">Total FUB Leads</div></div>
        <div style="background:white;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)"><div style="font-size:24px;font-weight:800;color:#ef4444" id="stat-new">0</div><div style="font-size:12px;color:#6b7280">Not Yet Called</div></div>
        <div style="background:white;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)"><div style="font-size:24px;font-weight:800;color:#10b981" id="stat-called">0</div><div style="font-size:12px;color:#6b7280">AI Called</div></div>
        <div style="background:white;padding:16px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)"><div style="font-size:24px;font-weight:800;color:#f59e0b" id="stat-appt">0</div><div style="font-size:12px;color:#6b7280">Appointments Booked</div></div>
      </div>

      <div style="margin-bottom:16px"><input type="text" id="fub-lead-search" placeholder="ğŸ” Search leads by name, email, phone, source..." oninput="filterFUBLeads()" style="width:100%;padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:white"></div>

      <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.07);overflow-x:auto">
        <table class="leads-table" id="fub-leads-table">
          <thead>
            <tr>
              <th>Score</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Source</th>
              <th>Interest</th>
              <th>FUB Stage</th>
              <th>AI Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="fub-leads-body">
            <tr><td colspan="8" style="text-align:center;padding:40px;color:#6b7280">Connect FUB to see your leads here</td></tr>
          </tbody>
        </table>
      </div>
    </div>


    <!-- HOT LEADS TAB -->
    <div class="tab-content" id="tab-hot-leads">
      <div style="background:#fff7ed;border:2px solid #f97316;border-radius:12px;padding:20px;margin-bottom:24px">
        <h2 style="font-size:20px;font-weight:800;color:#c2410c;margin-bottom:8px">ğŸ”¥ Hot Leads â€” Priority Calling</h2>
        <p style="color:#9a3412;font-size:14px;margin-bottom:12px">These leads are less than 7 days old or marked HOT in FUB. Call them ASAP!</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="ep-btn ep-btn-primary" onclick="callAllHot()">ğŸ“ Call All Hot Leads</button>
          <div style="font-size:13px;color:#9a3412;display:flex;align-items:center;gap:6px">
            <span style="font-weight:700">Business Hours:</span> M-F 9am-6pm, Sat-Sun 10am-5pm EST
          </div>
        </div>
      </div>
      
      <div style="background:white;border-radius:14px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08)">
        <table class="leads-table" id="hot-leads-table">
          <thead>
            <tr>
              <th>Score</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Source</th>
              <th>Age</th>
              <th>FUB Stage</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="hot-leads-body">
            <tr><td colspan="7" style="text-align:center;padding:40px;color:#6b7280">No hot leads right now</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- AI ACTIONS -->
    <div class="tab-content" id="tab-ai-actions">
      <h1 style="font-size:24px;font-weight:800;margin-bottom:20px">AI Action Center</h1>
      <div style="background:linear-gradient(135deg,#1e3a8a,#1a56db);border-radius:14px;padding:28px;color:white;margin-bottom:24px">
        <h2 style="font-size:20px;font-weight:700;margin-bottom:6px">ğŸ¤– Aria is working your leads right now</h2>
        <p style="opacity:.85;font-size:14px">Aria has made <strong>0 calls</strong>, sent <strong>0 texts</strong>, and booked <strong>0 appointments</strong> from your FUB leads this month.</p>
        <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
          <button class="ep-btn" style="background:rgba(255,255,255,.2);color:white;font-size:13px" onclick="aiCallAll()">ğŸ“ Call All Uncalled</button>
          <button class="ep-btn" style="background:rgba(255,255,255,.2);color:white;font-size:13px" onclick="aiTextAll()">ğŸ’¬ Text All New</button>
          <button class="ep-btn" style="background:rgba(255,255,255,.2);color:white;font-size:13px" onclick="aiFollowUp()">ğŸ”„ Follow Up Sequence</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.07)">
          <h3 style="font-weight:700;margin-bottom:16px">ğŸ“ AI Call Script</h3>
          <p style="font-size:13px;color:#6b7280;margin-bottom:12px">This is what Aria says when she calls your FUB leads:</p>
          <div style="background:#f9fafb;border-radius:8px;padding:16px;font-size:13px;line-height:1.8;border-left:3px solid #1a56db">
            <em>"Hi, is this [First Name]? Great! This is Aria calling on behalf of [Agent Name] from Emporion Pros. I saw you were recently looking at homes in the Newark area â€” I wanted to reach out personally to see if you had any questions or if you'd like to schedule a time to tour some properties. Do you have 2 minutes?"</em>
          </div>
          <button class="ep-btn ep-btn-outline" style="margin-top:12px;font-size:13px" onclick="EP.notify('Script editor coming soon!','info')">âœï¸ Customize Script</button>
        </div>

        <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.07)">
          <h3 style="font-weight:700;margin-bottom:16px">ğŸ’¬ AI Text Template</h3>
          <p style="font-size:13px;color:#6b7280;margin-bottom:12px">Text sent within 60 seconds of lead arriving:</p>
          <div style="background:#f9fafb;border-radius:8px;padding:16px;font-size:13px;line-height:1.8;border-left:3px solid #10b981">
            <em>"Hi [First Name]! ğŸ‘‹ This is Aria, [Agent Name]'s AI assistant at Emporion Pros. I saw you were browsing homes in Newark â€” I'd love to help you find the perfect place! Reply with your must-haves and I'll send over some great matches. ğŸ "</em>
          </div>
          <button class="ep-btn ep-btn-outline" style="margin-top:12px;font-size:13px" onclick="EP.notify('Text editor coming soon!','info')">âœï¸ Customize Text</button>
        </div>

        <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.07);grid-column:1/-1">
          <h3 style="font-weight:700;margin-bottom:16px">ğŸ“… Follow-Up Sequence</h3>
          <p style="font-size:13px;color:#6b7280;margin-bottom:16px">Aria follows up automatically if lead doesn't respond:</p>
          <div style="display:flex;flex-direction:column;gap:10px">
            ${[
              {time:'0 min', action:'ğŸ“ AI Phone Call', desc:'Aria calls immediately'},
              {time:'5 min', action:'ğŸ’¬ Text Message', desc:'Personal text if no answer'},
              {time:'1 hour', action:'ğŸ“§ Email', desc:'Property recommendations email'},
              {time:'24 hours', action:'ğŸ“ Follow-up Call', desc:'Second call attempt'},
              {time:'3 days', action:'ğŸ’¬ Check-in Text', desc:'"Still looking for a home?"'},
              {time:'1 week', action:'ğŸ“§ Market Update', desc:'Newark market stats email'},
            ].map(s => `
              <div style="display:flex;align-items:center;gap:14px;padding:12px;background:#f9fafb;border-radius:8px">
                <div style="background:#1a56db;color:white;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;white-space:nowrap">${s.time}</div>
                <div style="font-weight:600;font-size:14px">${s.action}</div>
                <div style="font-size:13px;color:#6b7280">${s.desc}</div>
                <div style="margin-left:auto"><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
              </div>`).join('')}
          </div>
          <button class="ep-btn ep-btn-primary" style="margin-top:16px" onclick="EP.notify('Sequence saved!','success')">Save Sequence âœ“</button>
        </div>
      </div>
    </div>

    <!-- ACTIVITY LOG -->
    <div class="tab-content" id="tab-activity">
      <h1 style="font-size:24px;font-weight:800;margin-bottom:20px">Activity Log</h1>
      <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.07)">
        <div id="activity-feed">
          <div style="text-align:center;padding:40px;color:#6b7280">
            <div style="font-size:48px;margin-bottom:12px">ğŸ“‹</div>
            <div>No activity yet. Connect FUB and send a test lead to get started!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- UPGRADE -->
    <div class="tab-content" id="tab-upgrade">
      <h1 style="font-size:24px;font-weight:800;margin-bottom:6px">Upgrade Your AI Plan</h1>
      <p style="color:#6b7280;margin-bottom:28px">Unlock AI calling, texting, and automatic FUB sync</p>
      <div class="addon-grid">
        <div class="addon-card">
          <div style="font-size:14px;font-weight:700;color:#6b7280;text-transform:uppercase">Starter</div>
          <div class="addon-price">Free</div>
          <div style="font-size:13px;color:#6b7280;margin-bottom:16px">Basic lead capture</div>
          <div class="addon-feature">âœ… List properties free</div>
          <div class="addon-feature">âœ… Emporion lead capture</div>
          <div class="addon-feature">âœ… Basic dashboard</div>
          <div class="addon-feature" style="color:#9ca3af">âŒ FUB integration</div>
          <div class="addon-feature" style="color:#9ca3af">âŒ AI calls</div>
          <div class="addon-feature" style="color:#9ca3af">âŒ AI texts</div>
          <button class="ep-btn ep-btn-outline" style="width:100%;margin-top:20px">Current Plan</button>
        </div>

        <div class="addon-card popular">
          <div class="popular-badge">ğŸ”¥ Most Popular</div>
          <div style="font-size:14px;font-weight:700;color:#1a56db;text-transform:uppercase">Pro AI</div>
          <div class="addon-price">$49<span style="font-size:16px;font-weight:400;color:#6b7280">/mo</span></div>
          <div style="font-size:13px;color:#6b7280;margin-bottom:16px">For active agents</div>
          <div class="addon-feature">âœ… Everything in Free</div>
          <div class="addon-feature">âœ… FUB Integration</div>
          <div class="addon-feature">âœ… AI texts to leads</div>
          <div class="addon-feature">âœ… AI email follow-ups</div>
          <div class="addon-feature">âœ… 50 AI calls/mo</div>
          <div class="addon-feature">âœ… Activity log</div>
          <button class="ep-btn ep-btn-primary" style="width:100%;margin-top:20px" onclick="startCheckout('pro')">Upgrade to Pro â†’</button>
        </div>

        <div class="addon-card">
          <div style="font-size:14px;font-weight:700;color:#7c3aed;text-transform:uppercase">Business AI</div>
          <div class="addon-price" style="color:#7c3aed">$99<span style="font-size:16px;font-weight:400;color:#6b7280">/mo</span></div>
          <div style="font-size:13px;color:#6b7280;margin-bottom:16px">For top producers</div>
          <div class="addon-feature">âœ… Everything in Pro</div>
          <div class="addon-feature">âœ… Unlimited AI calls</div>
          <div class="addon-feature">âœ… CINC Pro integration</div>
          <div class="addon-feature">âœ… Social media posting</div>
          <div class="addon-feature">âœ… Custom call scripts</div>
          <div class="addon-feature">âœ… Priority support</div>
          <button class="ep-btn" style="width:100%;margin-top:20px;background:#7c3aed;color:white" onclick="startCheckout('business')">Upgrade to Business â†’</button>
        </div>
      </div>

      <div style="background:#f0fdf4;border-radius:12px;padding:24px;margin-top:24px;text-align:center">
        <div style="font-size:24px;margin-bottom:8px">ğŸ’¡</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:4px">Why agents pay for this</div>
        <div style="color:#6b7280;font-size:14px;max-width:500px;margin:0 auto">Studies show calling a lead within 5 minutes makes you <strong>21x more likely to qualify them</strong> vs calling after 30 minutes. Aria does this automatically â€” even at 2am.</div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="tab-content" id="tab-settings">
      <h1 style="font-size:24px;font-weight:800;margin-bottom:20px">Integration Settings</h1>
      <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.07)">
        <h3 style="font-weight:700;margin-bottom:4px">FUB API Key</h3>
        <div style="display:flex;gap:10px;margin-bottom:24px">
          <input class="ep-input" id="settings-api-key" type="password" placeholder="fka_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="font-family:monospace">
          <button class="ep-btn ep-btn-outline" onclick="EP.notify('API key updated!','success')">Update</button>
        </div>
        <div class="setting-row"><div><div style="font-weight:600">Sync Frequency</div></div><select class="ep-select" style="width:auto"><option>Every 5 minutes</option><option>Every 15 minutes</option><option>Every hour</option></select></div>
        <div class="setting-row"><div><div style="font-weight:600">Notify me when Aria books an appointment</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="setting-row"><div><div style="font-weight:600">Push appointment back to FUB</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="setting-row"><div><div style="font-weight:600">Only call leads during business hours</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
        <div class="setting-row" style="border:none"><div><div style="font-weight:600">Disconnect FUB Integration</div><div style="font-size:13px;color:#6b7280">This will stop syncing leads from Follow Up Boss</div></div><button class="ep-btn ep-btn-outline" style="color:#ef4444;border-color:#ef4444" onclick="disconnectFUB()">Disconnect</button></div>
      </div>
    </div>

  </main>
</div>

<!-- Call Simulation Modal -->
<div class="call-modal" id="call-modal">
  <div class="call-box">
    <div style="font-size:12px;font-weight:700;color:#6b7280;text-transform:uppercase;margin-bottom:16px">Aria is calling...</div>
    <div class="call-avatar call-ring" id="call-avatar">?</div>
    <div id="call-name" style="font-size:20px;font-weight:800;margin-bottom:4px">Lead Name</div>
    <div id="call-phone" style="color:#6b7280;font-size:14px;margin-bottom:16px">Phone number</div>
    <div style="display:flex;justify-content:center;gap:8px;margin-bottom:12px">
      <span style="background:#d1fae5;color:#065f46;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600">ğŸ¤– Aria Speaking</span>
      <span id="call-timer" style="background:#f3f4f6;color:#374151;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600">0:00</span>
    </div>
    <div class="transcript-box" id="call-transcript"></div>
    <button class="ep-btn ep-btn-primary" onclick="closeCallModal()" style="width:100%">End Call</button>
  </div>
</div>

<div id="ai-mount"></div>
<script>
const SAMPLE_FUB_LEADS = []; // Real leads load from FUB API after backend is connected

let fubConnected = false;
let activityLog = [];

document.addEventListener('DOMContentLoaded', () => {
  const user = EP.auth.user();
  if (!user) { console.warn('No auth session â€” loading dashboard anyway'); }

  try {
    document.getElementById('header-mount').innerHTML = EP.renderHeader('');
    document.getElementById('ai-mount').innerHTML = EP.renderAIWidget();
  } catch(e) { console.warn('Header/AI widget error:', e); }

  // Show user name (fallback if no auth)
  const userName = (user && user.name) ? user.name : 'Ana';
  const initials = userName.split(' ').map(n=>n[0]).join('').toUpperCase();
  document.getElementById('fub-av').textContent = initials;
  document.getElementById('fub-name').textContent = userName;

  // Auto-connect FUB â€” always connect since API key is in Netlify env vars
  fubConnected = true;
  showConnected();
  syncFUBLeads();
});


function renderHotLeads() {
  const allLeads = scoreLeads();
  const hotLeads = allLeads.filter(l => l.score === 'hot');
  document.getElementById('hot-badge').textContent = hotLeads.length;
  
  const tbody = document.getElementById('hot-leads-body');
  if (hotLeads.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#6b7280">No hot leads right now</td></tr>';
    return;
  }
  
  tbody.innerHTML = hotLeads.map(l => {
    const age = l.ageText || 'Unknown';
    return `<tr>
      <td><div class="lead-score score-hot">ğŸ”¥</div></td>
      <td><strong>${l.name}</strong><br><small style="color:#6b7280">${l.email || 'No email'}</small></td>
      <td>${l.phone || 'No phone'}</td>
      <td>${l.source}</td>
      <td><span style="color:#ef4444;font-weight:600">${age}</span></td>
      <td>${l.stage}</td>
      <td>
        <a href="tel:${l.phone}" class="ai-action-btn btn-call" style="text-decoration:none;display:inline-flex;align-items:center">ğŸ“ Call</a>
        ${l.email?'<a href="mailto:'+l.email+'" class="ai-action-btn btn-text" style="text-decoration:none;display:inline-flex;align-items:center">ğŸ“§</a>':''}
        <button class="ai-action-btn btn-text" onclick="sendText(${l.id})">ğŸ’¬ Text</button>
        <button class="ai-action-btn" onclick="editLead('${encodeURIComponent(JSON.stringify({id:l.id,name:l.name,email:l.email,phone:l.phone,source:l.source,message:l.interest}))}')">âœï¸</button>
      </td>
    </tr>`;
  }).join('');
}

async function callAllHot() {
  if (!isBusinessHours()) {
    EP.notify('â° Outside business hours. Calls will be scheduled for tomorrow.', 'info');
    return;
  }
  
  const hotLeads = scoreLeads().filter(l => l.score === 'hot' && l.phone);
  if (hotLeads.length === 0) {
    EP.notify('No hot leads with phone numbers to call', 'info');
    return;
  }
  
  EP.notify(`ğŸ“ Calling ${hotLeads.length} hot leads...`, 'info');
  
  for (let i = 0; i < hotLeads.length; i++) {
    await makeCall(hotLeads[i].id);
    await new Promise(r => setTimeout(r, 30000)); // 30 sec between calls
  }
}

function showTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'leads' && fubConnected) renderLeads();
  if (name === 'hot-leads' && fubConnected) renderHotLeads();
}

function connectFUB() {
  const key = document.getElementById('fub-api-key').value.trim();
  if (!key) { EP.notify('Please enter your FUB API key', 'error'); return; }
  EP.store.set('ep_fub_key', key);
  fubConnected = true;
  showConnected();
  addActivity('sync', 'ğŸ”— Connected to Follow Up Boss', 'API key verified â€” syncing leads now...');
  EP.notify('âœ… Follow Up Boss connected! Syncing leads...', 'success');
  setTimeout(() => {
    addActivity('sync', 'ğŸ“¥ 5 leads imported from FUB', 'Maria Santos, James Williams, Rosa Jimenez, David Chen, Keisha Brown');
    document.getElementById('fub-badge').textContent = '5';
    EP.notify('ğŸ“¥ 5 leads imported from Follow Up Boss!', 'success');
  }, 2000);
}

function showConnected() {
  document.getElementById('connect-form').style.display = 'none';
  document.getElementById('connected-msg').style.display = 'block';
  const s = document.getElementById('connect-status');
  s.className = 'connect-status connected';
  s.innerHTML = '<div class="status-dot dot-green"></div><div><div style="font-weight:700;color:#065f46">âœ… Connected to Follow Up Boss</div><div style="font-size:13px;color:#065f46">Last synced: Just now</div></div>';
}

function disconnectFUB() {
  EP.store.set('ep_fub_key', null);
  fubConnected = false;
  document.getElementById('connect-form').style.display = 'block';
  document.getElementById('connected-msg').style.display = 'none';
  const s = document.getElementById('connect-status');
  s.className = 'connect-status disconnected';
  s.innerHTML = '<div class="status-dot dot-yellow"></div><div><div style="font-weight:700">Not Connected</div><div style="font-size:13px;color:#92400e">Enter your FUB API key below to connect</div></div>';
  EP.notify('FUB disconnected', 'info');
}


function scoreLeads() {
  const leads = EP.store.get('ep_fub_leads') || [];
  const now = new Date();
  
  return leads.map(lead => {
    // Use created date for scoring
    const createdDate = new Date(lead.created);
    const hoursSince = (now - createdDate) / (1000 * 60 * 60);
    
    let score = 'cold';
    let priority = 3;
    
    // Hot = created in last 7 days or FUB marked hot
    if (hoursSince < 168) {
      score = 'hot';
      priority = 1;
    }
    // Warm = created in last 30 days  
    else if (hoursSince < 720) {
      score = 'warm';
      priority = 2;
    }
    
    // Override with FUB temperature if hotter
    if (lead.score === 'hot') {
      score = 'hot';
      priority = 1;
    }
    
    // Calculate age text
    let ageText;
    if (hoursSince < 1) {
      ageText = 'Just now';
    } else if (hoursSince < 24) {
      ageText = Math.round(hoursSince) + 'h ago';
    } else {
      ageText = Math.round(hoursSince / 24) + 'd ago';
    }
    
    return { ...lead, score, priority, hoursSince, ageText };
  }).sort((a, b) => a.priority - b.priority || a.hoursSince - b.hoursSince);
}

function isBusinessHours() {
  const now = new Date();
  const day = now.getDay(); // 0=Sun, 6=Sat
  const hour = now.getHours();
  
  // Monday-Friday 9am-6pm
  if (day >= 1 && day <= 5) {
    return hour >= 9 && hour < 18;
  }
  // Saturday-Sunday 10am-5pm
  if (day === 0 || day === 6) {
    return hour >= 10 && hour < 17;
  }
  return false;
}

function renderLeads(filterText) {
  let leads = fubConnected ? scoreLeads() : [];
  document.getElementById('stat-total').textContent = leads.length;
  document.getElementById('stat-new').textContent = leads.filter(l => l.aiStatus.includes('Pending')).length;
  document.getElementById('stat-called').textContent = leads.filter(l => l.aiStatus.includes('Called') || l.aiStatus.includes('Texted')).length;
  document.getElementById('stat-appt').textContent = leads.filter(l => l.aiStatus.includes('Booked')).length;
  document.getElementById('fub-badge').textContent = leads.length;

  // Apply search filter
  if (filterText) {
    const q = filterText.toLowerCase();
    leads = leads.filter(l => (l.name||'').toLowerCase().includes(q) || (l.email||'').toLowerCase().includes(q) || (l.phone||'').toLowerCase().includes(q) || (l.source||'').toLowerCase().includes(q) || (l.interest||'').toLowerCase().includes(q));
  }

  document.getElementById('fub-leads-body').innerHTML = leads.map(l => `
    <tr style="cursor:pointer" onclick="openFUBLeadProfile(${l.id})">
      <td><div class="lead-score score-${l.score}">${l.score==='hot'?'ğŸ”¥':l.score==='warm'?'ğŸ˜Š':'â„ï¸'}</div></td>
      <td><div style="font-weight:700">${l.name}</div><div style="font-size:12px;color:#6b7280">${l.email}</div></td>
      <td style="font-family:monospace;font-size:13px">${l.phone}</td>
      <td><span style="background:#f3f4f6;padding:3px 8px;border-radius:6px;font-size:12px">${l.source}</span></td>
      <td style="font-size:13px;max-width:150px">${l.interest}</td>
      <td><span style="background:#dbeafe;color:#1e40af;padding:3px 8px;border-radius:6px;font-size:12px">${l.stage}</span></td>
      <td><span style="font-size:12px;color:${l.aiStatus.includes('Booked')?'#065f46':l.aiStatus.includes('Pending')?'#92400e':'#374151'};font-weight:600">${l.aiStatus}</span></td>
      <td>
        <div style="display:flex;gap:4px" onclick="event.stopPropagation()">
          <a href="tel:${l.phone}" class="ai-action-btn btn-call" style="text-decoration:none;display:inline-flex;align-items:center">ğŸ“ Call</a>
          ${l.email?'<a href="mailto:'+l.email+'" class="ai-action-btn btn-text" style="text-decoration:none;display:inline-flex;align-items:center">ğŸ“§</a>':''}
          <button class="ai-action-btn btn-text" onclick="sendText('${l.name.replace(/'/g,"\\'")}',${l.id})">ğŸ’¬ Text</button>
          <button class="ai-action-btn" onclick="editLead('${encodeURIComponent(JSON.stringify({id:l.id,name:l.name,email:l.email,phone:l.phone,source:l.source,message:l.interest}))}')">âœï¸</button>
        </div>
      </td>
    </tr>`).join('');
}

function filterFUBLeads() {
  const q = (document.getElementById('fub-lead-search')?.value || '').trim();
  renderLeads(q);
}

function openFUBLeadProfile(leadId) {
  const leads = scoreLeads();
  const l = leads.find(x => x.id === leadId);
  if (!l) return;
  const callNotes = EP.store.get('ep_call_notes_' + l.id) || [];
  const notesHtml = callNotes.length ? callNotes.map(n => '<div style="background:#f9fafb;padding:10px;border-radius:8px;margin-bottom:8px"><div style="font-size:11px;color:#6b7280;margin-bottom:2px">' + n.date + ' â€” ' + n.type + '</div><div style="font-size:13px">' + n.text + '</div></div>').join('') : '<div style="color:#6b7280;font-size:13px">No call notes yet</div>';
  const html = '<div id="fubLeadProfile" style="display:flex;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px)"><div style="background:white;border-radius:12px;padding:28px;width:92%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px"><div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:50%;background:#1a56db;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px">' + (l.name||'?')[0].toUpperCase() + '</div><div><h2 style="font-size:20px;font-weight:700;margin:0">' + l.name + '</h2><span style="font-size:12px;color:#6b7280">' + l.source + ' Â· ' + l.stage + '</span></div></div><button onclick="document.getElementById(\'fubLeadProfile\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280">âœ•</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px"><div style="background:#f9fafb;padding:12px;border-radius:8px"><div style="font-size:11px;color:#6b7280;margin-bottom:2px">Email</div><a href="mailto:' + l.email + '" style="font-size:13px;color:#1a56db;text-decoration:none">' + (l.email||'â€”') + '</a></div><div style="background:#f9fafb;padding:12px;border-radius:8px"><div style="font-size:11px;color:#6b7280;margin-bottom:2px">Phone</div><a href="tel:' + l.phone + '" style="font-size:13px;color:#1a56db;text-decoration:none">' + (l.phone||'â€”') + '</a></div><div style="background:#f9fafb;padding:12px;border-radius:8px"><div style="font-size:11px;color:#6b7280;margin-bottom:2px">Score</div><span style="font-size:13px;font-weight:600">' + (l.score==='hot'?'ğŸ”¥ Hot':l.score==='warm'?'ğŸ˜Š Warm':'â„ï¸ Cold') + '</span></div><div style="background:#f9fafb;padding:12px;border-radius:8px"><div style="font-size:11px;color:#6b7280;margin-bottom:2px">AI Status</div><span style="font-size:13px;font-weight:600">' + l.aiStatus + '</span></div></div>' + (l.interest ? '<div style="margin-bottom:16px"><div style="font-size:13px;font-weight:600;margin-bottom:4px;color:#374151">Interest</div><div style="font-size:13px;color:#6b7280;background:#f9fafb;padding:10px;border-radius:8px">' + l.interest + '</div></div>' : '') + '<div style="margin-bottom:16px"><div style="font-size:13px;font-weight:600;margin-bottom:8px;color:#374151">ğŸ“ Call Notes & AI Activity</div>' + notesHtml + '<div style="margin-top:10px"><textarea id="new-call-note" rows="2" placeholder="Add a note..." style="width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:7px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box"></textarea><button onclick="addCallNote(' + l.id + ')" style="margin-top:6px;padding:6px 14px;background:#1a56db;color:white;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">Save Note</button></div></div><div style="display:flex;gap:8px;justify-content:flex-end">' + (l.phone ? '<button onclick="document.getElementById(\'fubLeadProfile\').remove();simulateCall(\'' + l.name.replace(/'/g,"\\'") + '\',\'' + l.phone + '\',' + l.id + ')" style="padding:9px 18px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:#0e9f6e;color:white;font-family:inherit">ğŸ“ Call with Aria</button>' : '') + '<button onclick="document.getElementById(\'fubLeadProfile\').remove();editLead(\'' + encodeURIComponent(JSON.stringify({id:l.id,name:l.name,email:l.email,phone:l.phone,source:l.source,message:l.interest})) + '\')" style="padding:9px 18px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid #e5e7eb;background:white;color:#374151;font-family:inherit">âœï¸ Edit</button></div></div></div>';
  var ex = document.getElementById('fubLeadProfile');
  if (ex) ex.remove();
  document.body.insertAdjacentHTML('beforeend', html);
}

function addCallNote(leadId) {
  const text = document.getElementById('new-call-note')?.value?.trim();
  if (!text) return;
  const notes = EP.store.get('ep_call_notes_' + leadId) || [];
  notes.unshift({ date: new Date().toLocaleString(), type: 'Manual Note', text: text });
  EP.store.set('ep_call_notes_' + leadId, notes);
  document.getElementById('new-call-note').value = '';
  openFUBLeadProfile(leadId); // Refresh profile
}

function simulateCall(name, phone, id) {
  document.getElementById('call-avatar').textContent = name.charAt(0);
  document.getElementById('call-name').textContent = name;
  document.getElementById('call-phone').textContent = phone;
  document.getElementById('call-transcript').innerHTML = '';
  document.getElementById('call-modal').classList.add('open');

  let t = 0;
  const timer = setInterval(() => { t++; document.getElementById('call-timer').textContent = `${Math.floor(t/60)}:${String(t%60).padStart(2,'0')}`; }, 1000);

  const script = [
    {delay:1500, who:'aria', text:`Calling ${name}...`},
    {delay:3000, who:'aria', text:`Hi, is this ${name.split(' ')[0]}? This is Aria calling on behalf of Carlos Rivera at Emporion Pros.`},
    {delay:6000, who:'lead', text:`Yes, this is ${name.split(' ')[0]}.`},
    {delay:8000, who:'aria', text:`Great! I saw you were recently looking at homes in the Newark area. I wanted to personally reach out to see if you had any questions or would like to tour some properties.`},
    {delay:13000, who:'lead', text:`Actually yes, I've been looking for a 3-bedroom.`},
    {delay:15500, who:'aria', text:`Perfect! We have several great 3-bedroom options in Newark right now. Would you be available for a showing this weekend?`},
    {delay:20000, who:'lead', text:`Saturday works for me.`},
    {delay:22000, who:'aria', text:`Wonderful! I'll book you for Saturday at 11am with Carlos. You'll get a confirmation text shortly. Looking forward to it!`},
  ];

  script.forEach(s => {
    setTimeout(() => {
      const d = document.createElement('div');
      d.className = 't-line';
      d.innerHTML = `<span class="${s.who==='aria'?'t-aria':'t-lead'}">${s.who==='aria'?'ğŸ¤– Aria':'ğŸ‘¤ Lead'}:</span> ${s.text}`;
      document.getElementById('call-transcript').appendChild(d);
      document.getElementById('call-transcript').scrollTop = 9999;
    }, s.delay);
  });

  setTimeout(() => {
    clearInterval(timer);
    // Save call note
    const notes = EP.store.get('ep_call_notes_' + id) || [];
    notes.unshift({ date: new Date().toLocaleString(), type: 'AI Call (Aria)', text: 'Called lead. Duration: 25 sec. Appointment booked for Saturday 11am.' });
    EP.store.set('ep_call_notes_' + id, notes);
    addActivity('call', `ğŸ“ Aria called ${name}`, 'Call duration: 25 seconds â€” Appointment booked for Saturday 11am');
    EP.notify(`âœ… Aria booked an appointment with ${name.split(' ')[0]}!`, 'success');
  }, 24000);
}

function sendText(name, id) {
  const notes = EP.store.get('ep_call_notes_' + id) || [];
  notes.unshift({ date: new Date().toLocaleString(), type: 'AI Text (Aria)', text: 'Follow-up text sent: "Hi! This is Aria from EmporionPros. I\'d love to help you find your next home..."' });
  EP.store.set('ep_call_notes_' + id, notes);
  EP.notify(`ğŸ’¬ Text sent to ${name.split(' ')[0]}!`, 'success');
  addActivity('text', `ğŸ’¬ Text sent to ${name}`, 'Hi! This is Aria, Carlos\'s AI assistant. I\'d love to help you find a home in Newark...');
}

function closeCallModal() {
  document.getElementById('call-modal').classList.remove('open');
}

async function syncFUBLeads() {
  EP.notify('ğŸ”„ Syncing with Follow Up Boss...', 'info');
  try {
    const res = await fetch('/.netlify/functions/fub-leads');
    const data = await res.json();
    if (data.success && data.leads) {
      // Store real leads locally
      EP.store.set('ep_fub_leads', data.leads);
      EP.store.set('ep_fub_synced', data.syncedAt);
      document.getElementById('fub-badge').textContent = data.leads.length;
      EP.notify('âœ… Synced ' + data.leads.length + ' leads from Follow Up Boss!', 'success');
      addActivity('sync', 'ğŸ“¥ ' + data.leads.length + ' leads synced from FUB', 'Last sync: ' + new Date().toLocaleTimeString());
      if (document.getElementById('tab-leads').classList.contains('active')) renderLeads();
      renderHotLeads(); // Always update hot leads count

      // 2-WAY SYNC: Also save FUB leads to Supabase (via webhook function)
      // This ensures Supabase stays in sync even for manual syncs
      syncFUBLeadsToSupabase(data.leads);
    } else {
      EP.notify('âŒ Sync error: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch(err) {
    EP.notify('âŒ Could not connect to FUB: ' + err.message, 'error');
  }
}

// 2-WAY SYNC: Push FUB leads to Supabase (deduplicates on email)
async function syncFUBLeadsToSupabase(leads) {
  try {
    for (const lead of leads) {
      if (!lead.email) continue; // Skip leads without email
      await fetch('/.netlify/functions/fub-webhook', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event: 'peopleCreated',
          resourceIds: [lead.id],
          // Pass lead data directly to avoid re-fetching from FUB
          _directData: lead
        })
      }).catch(() => {}); // Don't block on individual failures
    }
    console.log('[EP Sync] FUB leads pushed to Supabase');
  } catch(err) {
    console.error('[EP Sync] Supabase sync error:', err);
  }
}

// 2-WAY SYNC: Push a new website lead to Follow Up Boss
async function pushLeadToFUB(leadData) {
  try {
    const res = await fetch('/.netlify/functions/sync-lead-to-fub', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(leadData)
    });
    const data = await res.json();
    if (data.success) {
      console.log('[EP Sync] Lead pushed to FUB:', data.fubPersonId);
      addActivity('sync', 'ğŸ“¤ Lead synced to FUB: ' + leadData.name, 'FUB Person ID: ' + data.fubPersonId);
    } else {
      console.error('[EP Sync] FUB push failed:', data.error);
    }
    return data;
  } catch(err) {
    console.error('[EP Sync] FUB push error:', err);
    return { success: false, error: err.message };
  }
}

function callAllNew() {
  if (!fubConnected) { EP.notify('Connect FUB first!', 'error'); return; }
  EP.notify('ğŸ“ Aria is calling all new leads now!', 'success');
  addActivity('call', 'ğŸ“ Bulk call initiated', 'Aria calling 2 new leads: Maria Santos, Rosa Jimenez');
}

function aiCallAll() { callAllNew(); }
function aiTextAll() { EP.notify('ğŸ’¬ Texts sent to all new leads!', 'success'); addActivity('text', 'ğŸ’¬ Bulk text sent', '5 leads texted with personalized messages'); }
function aiFollowUp() { EP.notify('ğŸ”„ Follow-up sequence started for all leads!', 'success'); }

function sendTestLead() {
  const testLead = { id: Date.now(), name:'Test Lead', phone:'(973) 555-0000', email:'test@test.com', source:'Test', interest:'3BR Newark', stage:'New', score:'hot', aiStatus:'Pending Call' };
  SAMPLE_FUB_LEADS.unshift(testLead);
  addActivity('sync', 'ğŸ§ª Test lead received from FUB', 'Name: Test Lead | Source: Test | Interest: 3BR Newark');
  addActivity('call', 'ğŸ“ Aria called Test Lead', 'Initiated within 30 seconds of lead arriving');
  EP.notify('âœ… Test lead sent! Check Activity Log.', 'success');
  showTab('activity', document.querySelectorAll('.nav-item')[3]);

  // 2-WAY SYNC: Also push test lead to FUB
  pushLeadToFUB({ name: 'Test Lead', email: 'test@test.com', phone: '9735550000', source: 'website', page: '/fub-aria-dashboard.html', role: 'user' });
}

function addActivity(type, title, detail) {
  const icons = { call:'activity-call', text:'activity-text', sync:'activity-sync' };
  const emojis = { call:'ğŸ“', text:'ğŸ’¬', sync:'ğŸ”„' };
  const feed = document.getElementById('activity-feed');
  const item = document.createElement('div');
  item.className = 'activity-item';
  item.innerHTML = `<div class="activity-icon ${icons[type]}">${emojis[type]}</div><div><div style="font-weight:600;font-size:14px">${title}</div><div style="font-size:13px;color:#6b7280">${detail}</div><div style="font-size:11px;color:#9ca3af;margin-top:2px">${new Date().toLocaleTimeString()}</div></div>`;
  if (feed.querySelector('div[style]')) feed.innerHTML = '';
  feed.insertBefore(item, feed.firstChild);
}

function startCheckout(plan) {
  EP.notify(`Redirecting to checkout for ${plan} plan... (Stripe integration coming soon!)`, 'info');
}

function toggleSetting(el, name) {
  el.classList.toggle('on');
  EP.notify(`AI ${name} ${el.classList.contains('on') ? 'enabled' : 'disabled'}`, 'info');
}
</script>

<!-- EXCEL UPLOAD MODAL -->
<div id="uploadModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px)">
  <div style="background:white;border-radius:12px;padding:28px;width:90%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="font-size:18px;font-weight:700">ğŸ“¤ Upload Leads</h2>
      <button onclick="closeUploadModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280">âœ•</button>
    </div>
    <div id="uploadDropZone" style="border:2px dashed #d1d5db;border-radius:10px;padding:40px 20px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:16px"
      ondragover="event.preventDefault();this.style.borderColor='#1a56db';this.style.background='#eff6ff'"
      ondragleave="this.style.borderColor='#d1d5db';this.style.background='white'"
      ondrop="event.preventDefault();this.style.borderColor='#d1d5db';this.style.background='white';handleUploadFile(event.dataTransfer.files[0])"
      onclick="document.getElementById('uploadFileInput').click()">
      <div style="font-size:36px;margin-bottom:8px">ğŸ“</div>
      <div style="font-size:14px;font-weight:600;color:#374151">Drag & drop Excel or CSV file here</div>
      <div style="font-size:12px;color:#9ca3af;margin-top:4px">or click to browse â€” .xlsx, .xls, .csv</div>
    </div>
    <input type="file" id="uploadFileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleUploadFile(this.files[0])">
    <div id="uploadPreview" style="display:none;margin-bottom:16px">
      <div style="font-size:13px;font-weight:600;margin-bottom:8px" id="uploadFileName"></div>
      <div style="max-height:200px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px" id="uploadPreviewTable"></div>
      <div style="font-size:12px;color:#6b7280;margin-top:8px" id="uploadSummary"></div>
    </div>
    <div id="uploadProgress" style="display:none;margin-bottom:16px">
      <div style="height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden"><div id="uploadBar" style="height:100%;background:#1a56db;border-radius:3px;width:0%;transition:width .3s"></div></div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px" id="uploadStatus">Uploading...</div>
    </div>
    <div id="uploadResult" style="display:none;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px"></div>
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
      <span style="font-size:12px;color:#6b7280">Columns: Name, Email, Phone, Source</span>
      <div style="display:flex;gap:8px">
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#374151"><input type="checkbox" id="uploadPushFUB" checked> Also push to FUB</label>
        <button class="ep-btn ep-btn-primary" id="uploadBtn" onclick="submitUpload()" disabled style="padding:8px 16px;font-size:13px">Upload Leads</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================
// LEAD FORM MODULE â€” Dynamic Add/Edit Lead
// ============================================
const LeadForm=(function(){const LEAD_TYPES=['Renter','Buyer','Seller','Commercial','Investor','Vendor'];
const RENTER_BUDGETS=['Under $2,000','$2,000-$2,400','$2,400-$2,700','$2,700-$3,000','$3,000-$3,500','$3,500+'];
const RENTER_SIZES=['Studio','1 Bedroom','1BR Flex / Convertible','2 Bedroom','2BR Duplex','3 Bedroom','3BR Duplex','4+ Bedroom'];
const BUYER_PROPERTY_TYPES=['House','Condo','Townhouse','Multi-Family','Co-op','New Construction','Land','Other'];
const BUYER_PRICE_POINTS=['Under $100K','$100K-$200K','$200K-$300K','$300K-$400K','$400K-$500K','$500K-$750K','$750K-$1M','$1M-$2M','$2M+'];
const COMMERCIAL_TYPES=['Office','Retail','Industrial','Mixed-Use','Warehouse','Restaurant/Bar','Medical','Other'];
const COMMERCIAL_BUDGETS=['Under $2,000/mo','$2,000-$3,500/mo','$3,500-$5,000/mo','$5,000-$7,500/mo','$7,500-$10,000/mo','$10,000+/mo','Under $500K Purchase','$500K-$1M','$1M-$2M','$2M+'];
const COMMERCIAL_LEASE_TERMS=['Month-to-Month','1 Year','2 Years','3 Years','5 Years','10 Years','Flexible'];
const COMMERCIAL_BIZ_TYPES=['Restaurant','Retail Store','Office/Professional','Medical/Dental','Salon/Barbershop','Gym/Fitness','Daycare','Auto Shop','Tech/Startup','Non-Profit','Other'];
const INVESTOR_TYPES=['Multi-Family','Fix & Flip','Buy & Hold','Commercial','New Development','Mixed-Use','Land','Other'];
const TIMEFRAMES=['ASAP','1 Month','2 Months','3 Months','4-6 Months','6-12 Months','12+ Months','Just Browsing'];
const INCOMES=['Under $4,000','$4,000-$6,000','$6,000-$8,000','$8,000-$10,000','$10,000+'];
const CREDITS=['750+','700-749','650-699','600-649','Below 600','No Credit'];
const SOURCES=['Website','Zillow','Apartments.com','Realtor.com','Referral','Walk-in','Follow Up Boss','Social Media','Google','Other'];
const VENDOR_SERVICES=['Plumbing','HVAC','Electrical','General Contractor','Cleaning','Landscaping','Pest Control','Locksmith','Painting','Roofing','Moving','Photography','Staging','Inspection','Appraisal','Title & Settlement','Mortgage','Insurance','Real Estate Attorney','Property Management','Other'];
const PREAPPROVED=['Yes','No','In Process'];
function opt(v,s){return '<option value="'+v+'" '+(s===v?'selected':'')+'>'+v+'</option>';}
function sel(id,lbl,opts,s){return '<div><label class="lf-label">'+lbl+'</label><select id="'+id+'" class="lf-input" onchange="LeadForm.handleOther(this)">'+opts.map(function(o){return opt(o,s);}).join('')+'</select><input type="text" id="'+id+'-other" class="lf-input" placeholder="Please specify..." style="display:none;margin-top:6px"></div>';}
function selE(id,lbl,opts,s){return '<div><label class="lf-label">'+lbl+'</label><select id="'+id+'" class="lf-input" onchange="LeadForm.handleOther(this)"><option value="">Select...</option>'+opts.map(function(o){return opt(o,s);}).join('')+'</select><input type="text" id="'+id+'-other" class="lf-input" placeholder="Please specify..." style="display:none;margin-top:6px"></div>';}
function inp(id,lbl,t,ph,v){return '<div><label class="lf-label">'+lbl+'</label><input type="'+t+'" id="'+id+'" class="lf-input" placeholder="'+ph+'" value="'+(v||'')+'"></div>';}
function ta(id,lbl,ph,v){return '<div style="grid-column:1/-1"><label class="lf-label">'+lbl+'</label><textarea id="'+id+'" class="lf-input" rows="2" placeholder="'+ph+'" style="resize:vertical">'+(v||'')+'</textarea></div>';}
function dynFields(type,d){d=d||{};switch(type){
case 'Renter':return '<div class="lf-grid2">'+selE('lf-budget','Budget *',RENTER_BUDGETS,d.budget)+selE('lf-aptSize','Apartment Size',RENTER_SIZES,d.aptSize)+'</div><div class="lf-grid2">'+selE('lf-timeframe','Move-in Timeline',TIMEFRAMES,d.timeframe)+selE('lf-income','Monthly Income',INCOMES,d.income)+'</div><div class="lf-grid2">'+selE('lf-credit','Credit Score',CREDITS,d.credit)+inp('lf-zip','Preferred Zip / Location','text','07102, Downtown Newark...',d.zip)+'</div>';
case 'Buyer':return '<div class="lf-grid2">'+selE('lf-propType','Property Type *',BUYER_PROPERTY_TYPES,d.propType)+selE('lf-priceRange','Price Range *',BUYER_PRICE_POINTS,d.priceRange)+'</div><div class="lf-grid2">'+selE('lf-timeframe','Timeframe',TIMEFRAMES,d.timeframe)+inp('lf-beds','Bedrooms','text','3+',d.beds)+'</div><div class="lf-grid2">'+selE('lf-income','Income',INCOMES,d.income)+selE('lf-credit','Credit Score',CREDITS,d.credit)+'</div><div class="lf-grid2">'+inp('lf-zip','Preferred Zip / Location','text','07102, South Ward...',d.zip)+selE('lf-preapproved','Pre-Approved?',PREAPPROVED,d.preapproved)+'</div>';
case 'Seller':return '<div class="lf-grid2">'+selE('lf-propType','Property Type',BUYER_PROPERTY_TYPES,d.propType)+inp('lf-address','Property Address','text','123 Main St, Newark NJ',d.address)+'</div><div class="lf-grid2">'+selE('lf-priceRange','Asking Price Range',BUYER_PRICE_POINTS,d.priceRange)+selE('lf-timeframe','Selling Timeline',TIMEFRAMES,d.timeframe)+'</div><div class="lf-grid2">'+inp('lf-zip','Property Zip','text','07102',d.zip)+inp('lf-beds','Beds / Baths','text','3BR / 2BA',d.beds)+'</div>';
case 'Commercial':return '<div class="lf-grid2">'+selE('lf-commType','Space Type *',COMMERCIAL_TYPES,d.commType)+selE('lf-bizType','Type of Business *',COMMERCIAL_BIZ_TYPES,d.bizType)+'</div><div class="lf-grid2">'+selE('lf-budget','Budget *',COMMERCIAL_BUDGETS,d.budget)+inp('lf-sqft','Square Footage','text','1,000-5,000 sq ft',d.sqft)+'</div><div class="lf-grid2">'+selE('lf-leaseTerm','Lease Term',COMMERCIAL_LEASE_TERMS,d.leaseTerm)+selE('lf-timeframe','Timeframe',TIMEFRAMES,d.timeframe)+'</div><div class="lf-grid2">'+inp('lf-zip','Preferred Zip / Location','text','07102, Downtown...',d.zip)+inp('lf-criteria','Search Criteria','text','Parking, loading dock...',d.criteria)+'</div>';
case 'Investor':return '<div class="lf-grid2">'+selE('lf-invType','Investment Type *',INVESTOR_TYPES,d.invType)+selE('lf-priceRange','Investment Budget',BUYER_PRICE_POINTS,d.priceRange)+'</div><div class="lf-grid2">'+selE('lf-timeframe','Timeframe',TIMEFRAMES,d.timeframe)+inp('lf-zip','Target Zip / Location','text','07102, Newark...',d.zip)+'</div><div class="lf-grid2">'+inp('lf-units','Min Units / Size','text','4+ units, 10,000 sq ft...',d.units)+inp('lf-criteria','Search Criteria','text','Cap rate 8%+, value-add...',d.criteria)+'</div>';
case 'Vendor':return '<div class="lf-grid2">'+inp('lf-business','Business Name','text','ABC Plumbing',d.business)+selE('lf-service','Service Type *',VENDOR_SERVICES,d.service)+'</div><div class="lf-grid2">'+inp('lf-zip','Service Area / Zip','text','07102, Essex County...',d.zip)+inp('lf-license','License #','text','Optional',d.license)+'</div>';
default:return '';}}
function parseMsg(m){if(!m)return {};var d={};var match=m.match(/---\s*(.+)/);if(match){match[1].split(' | ').forEach(function(p){var parts=p.split(': ');if(parts.length>=2){var k=parts[0].trim().toLowerCase(),v=parts.slice(1).join(': ').trim();if(k==='type')d.leadType=v;else if(k==='budget')d.budget=v;else if(k==='size')d.aptSize=v;else if(k==='timeline')d.timeframe=v;else if(k==='income')d.income=v;else if(k==='credit')d.credit=v;else if(k==='location')d.zip=v;else if(k==='property type')d.propType=v;else if(k==='price')d.priceRange=v;else if(k==='beds')d.beds=v;else if(k==='commercial type'||k==='space type')d.commType=v;else if(k==='business type')d.bizType=v;else if(k==='lease term')d.leaseTerm=v;else if(k==='investment type')d.invType=v;else if(k==='criteria')d.criteria=v;else if(k==='sqft')d.sqft=v;else if(k==='pre-approved')d.preapproved=v;else if(k==='address')d.address=v;else if(k==='business')d.business=v;else if(k==='service')d.service=v;else if(k==='license')d.license=v;else if(k==='units')d.units=v;}});}d.notes=m.split('---')[0].trim();return d;}
function getVal(id){var el=document.getElementById(id);if(!el)return '';var v=el.value;if(v==='Other'){var oth=document.getElementById(id+'-other');return oth&&oth.value?oth.value:v;}return v;}
function buildMsg(type,notes){var f=[];if(type)f.push('Type: '+type);var tryA=function(id,lbl){var v=getVal(id);if(v&&v!=='Select...')f.push(lbl+': '+v);};tryA('lf-budget','Budget');tryA('lf-aptSize','Size');tryA('lf-timeframe','Timeline');tryA('lf-income','Income');tryA('lf-credit','Credit');tryA('lf-zip','Location');tryA('lf-propType','Property Type');tryA('lf-priceRange','Price');tryA('lf-beds','Beds');tryA('lf-preapproved','Pre-Approved');tryA('lf-address','Address');tryA('lf-commType','Space Type');tryA('lf-bizType','Business Type');tryA('lf-leaseTerm','Lease Term');tryA('lf-invType','Investment Type');tryA('lf-sqft','SqFt');tryA('lf-criteria','Criteria');tryA('lf-units','Units');tryA('lf-business','Business');tryA('lf-service','Service');tryA('lf-license','License');return [notes,f.length?'--- '+f.join(' | '):''].filter(Boolean).join('\n');}
function renderModal(lead){var isEdit=!!lead;var title=isEdit?'Edit Lead':'Add New Lead';var btnText=isEdit?'Save Changes':'Add Lead';var parsed=isEdit?parseMsg(lead.message):{};var currentType=parsed.leadType||'Renter';
var typeButtons='';LEAD_TYPES.forEach(function(t){typeButtons+='<button class="lf-type-btn '+(t===currentType?'active':'')+'" onclick="LeadForm.switchType(\''+t+'\')">'+t+'</button>';});
var html='<div id="leadFormModal" style="display:flex;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px)"><div style="background:white;border-radius:12px;padding:28px;width:92%;max-width:580px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)"><style>.lf-label{display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px}.lf-input{width:100%;padding:9px 12px;border:1px solid #e5e7eb;border-radius:7px;font-size:13px;font-family:inherit;box-sizing:border-box}.lf-input:focus{outline:none;border-color:#1a56db;box-shadow:0 0 0 3px rgba(26,86,219,.1)}.lf-grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}.lf-types{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}.lf-type-btn{padding:7px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid #e5e7eb;background:white;color:#374151;cursor:pointer;transition:.2s}.lf-type-btn:hover{border-color:#1a56db;color:#1a56db}.lf-type-btn.active{background:#1a56db;color:white;border-color:#1a56db}</style>';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 style="font-size:18px;font-weight:700;margin:0">'+(isEdit?'&#9998; ':' &#10133; ')+title+'</h2><button onclick="LeadForm.close()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#6b7280">&#10005;</button></div>';
html+='<div style="margin-bottom:14px"><label class="lf-label">Lead Type</label><div class="lf-types" id="lf-types">'+typeButtons+'</div></div>';
html+='<div class="lf-grid2">'+inp('lf-fname','First Name *','text','John',isEdit?(lead.name||'').split(' ')[0]:'')+inp('lf-lname','Last Name *','text','Smith',isEdit?(lead.name||'').split(' ').slice(1).join(' '):'')+'</div>';
html+='<div class="lf-grid2">'+inp('lf-email','Email *','email','john@email.com',isEdit?lead.email:'')+inp('lf-phone','Phone','tel','(555) 123-4567',isEdit?lead.phone:'')+'</div>';
html+='<div class="lf-grid2">'+sel('lf-source','Source',SOURCES,isEdit?lead.source:'Website')+'</div>';
html+='<div id="lf-dynamic">'+dynFields(currentType,parsed)+'</div>';
html+=ta('lf-notes','Notes','Any notes about this lead...',parsed.notes||'');
if(isEdit)html+='<input type="hidden" id="lf-edit-id" value="'+lead.id+'">';
html+='<input type="hidden" id="lf-lead-type" value="'+currentType+'">';
html+='<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;align-items:center"><button onclick="LeadForm.close()" style="padding:9px 18px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid #e5e7eb;background:white;color:#374151;font-family:inherit">Cancel</button><label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#374151;margin-right:8px"><input type="checkbox" id="lf-pushFUB" checked> Push to FUB</label><button id="lf-submit-btn" onclick="LeadForm.submit()" style="padding:9px 18px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:#1a56db;color:white;font-family:inherit">'+btnText+'</button></div>';
html+='</div></div>';return html;}
return {
open:function(lead){var ex=document.getElementById('leadFormModal');if(ex)ex.remove();document.body.insertAdjacentHTML('beforeend',renderModal(lead));},
close:function(){var m=document.getElementById('leadFormModal');if(m)m.remove();},
switchType:function(type){document.getElementById('lf-lead-type').value=type;document.querySelectorAll('.lf-type-btn').forEach(function(b){b.classList.toggle('active',b.textContent===type);});document.getElementById('lf-dynamic').innerHTML=dynFields(type,{});},
handleOther:function(el){var othEl=document.getElementById(el.id+'-other');if(othEl){othEl.style.display=el.value==='Other'?'block':'none';if(el.value!=='Other')othEl.value='';}},
submit:async function(){var fname=document.getElementById('lf-fname').value.trim();var lname=document.getElementById('lf-lname').value.trim();var email=document.getElementById('lf-email').value.trim();var phone=document.getElementById('lf-phone').value.trim();var source=getVal('lf-source');var leadType=document.getElementById('lf-lead-type').value;var notes=document.getElementById('lf-notes').value.trim();var pushToFUB=document.getElementById('lf-pushFUB').checked;if(!fname||!lname){alert('First name and last name are required');return;}if(!email){alert('Email is required');return;}var name=fname+' '+lname;var message=buildMsg(leadType,notes);var editId=document.getElementById('lf-edit-id');var isEdit=!!editId;var btn=document.getElementById('lf-submit-btn');btn.disabled=true;btn.textContent=isEdit?'Saving...':'Adding...';try{var res=await fetch('/.netlify/functions/upload-leads',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leads:[{name:name,email:email,phone:phone,source:source,message:message,role:'user'}],pushToFUB:pushToFUB})});var data=await res.json();if(data.success){LeadForm.close();LeadForm._refresh();alert(isEdit?'Lead updated!':'Lead added!'+(data.fubPushed?' Pushed to FUB.':''));}else{alert('Error: '+(data.error||'Unknown'));}}catch(err){alert('Error: '+err.message);}btn.disabled=false;btn.textContent=isEdit?'Save Changes':'Add Lead';},
_refresh:function(){if(typeof loadOverview==='function')loadOverview();if(typeof loadLeads==='function')loadLeads();if(typeof renderLeads==='function')renderLeads();if(typeof renderHotLeads==='function')renderHotLeads();if(typeof syncFUBLeads==='function')syncFUBLeads();}
};})();
function openAddLeadModal(){LeadForm.open();}
function closeAddLeadModal(){LeadForm.close();}
function editLead(j){LeadForm.open(JSON.parse(decodeURIComponent(j)));}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let uploadedLeads = [];

function openUploadModal() {
  document.getElementById('uploadModal').style.display = 'flex';
  resetUploadModal();
}
function closeUploadModal() {
  document.getElementById('uploadModal').style.display = 'none';
}
function resetUploadModal() {
  uploadedLeads = [];
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('uploadResult').style.display = 'none';
  document.getElementById('uploadBtn').disabled = true;
  document.getElementById('uploadDropZone').style.display = 'block';
  document.getElementById('uploadFileInput').value = '';
}

function handleUploadFile(file) {
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx', 'xls', 'csv'].includes(ext)) {
    EP.notify('Please upload an Excel (.xlsx/.xls) or CSV file', 'error');
    return;
  }
  document.getElementById('uploadFileName').textContent = 'ğŸ“„ ' + file.name;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      let data;
      if (ext === 'csv') {
        const text = e.target.result;
        const rows = text.split('\n').map(r => r.split(',').map(c => c.trim().replace(/^"|"$/g, '')));
        const headers = rows[0];
        data = rows.slice(1).filter(r => r.some(c => c)).map(r => {
          const obj = {};
          headers.forEach((h, i) => { obj[h] = r[i] || ''; });
          return obj;
        });
      } else {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(ws);
      }
      uploadedLeads = data;
      showUploadPreview(data);
    } catch (err) {
      EP.notify('Error reading file: ' + err.message, 'error');
    }
  };
  if (ext === 'csv') reader.readAsText(file);
  else reader.readAsBinaryString(file);
}

function showUploadPreview(data) {
  if (!data.length) { EP.notify('No data found in file', 'error'); return; }
  const keys = Object.keys(data[0]);
  const preview = data.slice(0, 5);
  let html = '<table style="width:100%;font-size:12px;border-collapse:collapse"><thead><tr>';
  keys.forEach(k => { html += '<th style="padding:6px 8px;background:#f9fafb;text-align:left;font-size:11px;color:#6b7280">' + k + '</th>'; });
  html += '</tr></thead><tbody>';
  preview.forEach(row => {
    html += '<tr>';
    keys.forEach(k => { html += '<td style="padding:5px 8px;border-top:1px solid #f3f4f6;font-size:12px">' + (row[k] || '') + '</td>'; });
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('uploadPreviewTable').innerHTML = html;
  document.getElementById('uploadSummary').textContent = data.length + ' leads found' + (data.length > 5 ? ' (showing first 5)' : '');
  document.getElementById('uploadPreview').style.display = 'block';
  document.getElementById('uploadDropZone').style.display = 'none';
  document.getElementById('uploadBtn').disabled = false;
}

async function submitUpload() {
  if (!uploadedLeads.length) return;
  const btn = document.getElementById('uploadBtn');
  btn.disabled = true;
  btn.textContent = 'Uploading...';
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('uploadBar').style.width = '30%';
  document.getElementById('uploadStatus').textContent = 'Sending ' + uploadedLeads.length + ' leads...';

  const pushToFUB = document.getElementById('uploadPushFUB').checked;

  try {
    document.getElementById('uploadBar').style.width = '60%';
    const res = await fetch('/.netlify/functions/upload-leads', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ leads: uploadedLeads, pushToFUB })
    });
    const data = await res.json();
    document.getElementById('uploadBar').style.width = '100%';

    const resultEl = document.getElementById('uploadResult');
    if (data.success) {
      resultEl.style.background = '#d1fae5';
      resultEl.style.color = '#065f46';
      resultEl.innerHTML = 'âœ… <strong>Upload complete!</strong><br>Created: ' + data.created + ' | Updated: ' + data.updated + ' | Skipped: ' + data.skipped + (data.fubPushed ? ' | Pushed to FUB: ' + data.fubPushed : '') + (data.errors ? ' | Errors: ' + data.errors : '');
      EP.notify('âœ… ' + data.created + ' leads uploaded!', 'success');
    } else {
      resultEl.style.background = '#fee2e2';
      resultEl.style.color = '#991b1b';
      resultEl.innerHTML = 'âŒ Upload failed: ' + (data.error || 'Unknown error');
      EP.notify('Upload failed', 'error');
    }
    resultEl.style.display = 'block';
    document.getElementById('uploadStatus').textContent = 'Done!';

    // Refresh leads if connected
    if (typeof renderLeads === 'function' && fubConnected) renderLeads();
    if (typeof renderHotLeads === 'function') renderHotLeads();
  } catch (err) {
    document.getElementById('uploadResult').style.display = 'block';
    document.getElementById('uploadResult').style.background = '#fee2e2';
    document.getElementById('uploadResult').style.color = '#991b1b';
    document.getElementById('uploadResult').innerHTML = 'âŒ Error: ' + err.message;
    EP.notify('Upload error: ' + err.message, 'error');
  }
  btn.textContent = 'Upload Leads';
  btn.disabled = false;
}
</script>
</body>
</html>
